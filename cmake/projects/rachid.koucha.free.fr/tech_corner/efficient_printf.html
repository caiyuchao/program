<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>How to use printf() efficiently</title>
  <meta name="author" content="rachid koucha">
  <meta name="Category"
 content="WEB site, Linux, freeware, PMA430, freebox">
  <meta name="language" content="en">
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
  <meta http-equiv="Content-Language" content="en">
  <meta name="description" content="How to use printf() efficiently">
  <meta name="keywords"
 content="linux, ubuntu, C library, printf, efficient coding">
  <script type="text/javascript"
 src="https://apis.google.com/js/plusone.js"></script>
</head>
<body>
<small><small><span style="text-decoration: underline;"></span></small></small><small><a
 href="../technical_documents.html">Go back to previous page</a><br>
<a href="../../index.html">Go back to home page</a></small><br>
<br>
<small><small><span style="text-decoration: underline;">Last update</span>:
16-May-2010<br>
<span style="text-decoration: underline;">Author</span>: R. Koucha</small></small><br>
<h1 style="text-align: center;">How to use <span
 style="font-style: italic;">printf()</span> efficiently<br>
</h1>
<table
 style="text-align: left; margin-left: auto; margin-right: auto; background-color: rgb(192, 192, 192);">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript"
 src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
<table style="text-align: left; width: 100%;" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top; height: 50%; width: 50%;"><br>
      </td>
      <td style="vertical-align: top;"><iframe
 src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fefficient_printf.html&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light&amp;height=80"
 style="border: medium none ; overflow: hidden; width: 450px; height: 80px;"
 allowtransparency="true" frameborder="0" scrolling="no"></iframe> <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><g:plusone size="medium"></g:plusone>
      <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><a
 href="mailto:?body=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fefficient_printf.html&amp;subject=How%20to%20use%20printf%28%29%20efficiently"><img
 alt="s" src="../send_to_a_friend.gif"
 style="border: 0px solid ; width: 30px; height: 21px;"></a></td>
    </tr>
  </tbody>
</table>
<br>
<br>
<br>
<h2>Introduction</h2>
In lots of software, I can see the following in <font color="#ff0000">red
color</font> (one example among numerous ones !):<br>
<br>
<tt>BRCode_t ethsw_run_print_bist(int switch_ID)<br>
{<br>
&nbsp; ethsw_bist_t bist_result;<br>
&nbsp; BRCode_t rt;<br>
&nbsp; char * sw_name;<br>
&nbsp; if (!KETHSW_VALID_SWITCH_ID(switch_ID))<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; printf("Invalid switch ID (%d)\n", switch_ID);<br>
&nbsp;&nbsp;&nbsp; return BRC_ERR;<br>
&nbsp; }<br>
<br>
&nbsp; rt = ethsw_bist_run(switch_ID, &amp;bist_result);<br>
&nbsp; <br>
<font color="#ff0000">&nbsp; printf("BIST result:\n");<br>
</font><br>
&nbsp; switch (bist_result.device_ID)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33032_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME1;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33036_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME3;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33050_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME2;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; default:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name = "Unknown
switch !";<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
<font color="#ff0000">&nbsp; printf("&nbsp;&nbsp;&nbsp; Device
ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : %s (0x%x)\n",
sw_name,bist_result.device_ID);<br>
&nbsp; printf("&nbsp;&nbsp;&nbsp; Device revision: %d\n",&nbsp;
bist_result.device_revision);<br>
&nbsp; printf("&nbsp;&nbsp;&nbsp; RAM status&nbsp;&nbsp;&nbsp;&nbsp; :
%s\n", (bist_result.RAM_OK&nbsp;&nbsp;&nbsp;&nbsp; )?"OK"
:"KO");<br>
&nbsp; printf("&nbsp;&nbsp;&nbsp; BIST result&nbsp;&nbsp;&nbsp; :
%s\n", (rt ==
BRC_OK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
)?"OK"
:"KO");<br>
&nbsp; printf("\n!! Warning: Switch has been stopped and restarted to
run
BIST !!\n");<br>
</font>&nbsp; <br>
&nbsp; return rt;<br>
}</tt><br>
<br>
This is bad for the following reasons :<br>
<h5>1. This is not efficient<br>
</h5>
Why are we calling <i>printf()</i> several times since only one call
would be sufficient. We would save some CPU time.<br>
<h5>2. The displays may be mixed<br>
</h5>
As the data are displayed in multiple shots (one shot per <i>printf()</i>
call), the calling task may be preempted between the calls by another
task which may call <i>printf()</i> as well. So, this would trigger
the mix of displays coming from multiple tasks. This does not
facilitate the reading of the traces while debugging !<br>
<h5>3. The memory footprint is more important<br>
</h5>
The multiple calls to <i>printf()</i> triggers the generation of
multiple identical sets of instructions: one set per <i>printf()</i>
call. This makes the generated code fat.<br>
<h2>Proposed better code</h2>
Here is the function fixed to avoid trace mixing, save memory space
(the assembly code shows that we save <font color="#ff0000"><b><u>92
bytes</u></b></font> of instructions on a PowerPC architecture) and
save some CPU time...<br>
<br>
<tt><br>
BRCode_t ethsw_run_print_bist(int switch_ID)<br>
{<br>
&nbsp; ethsw_bist_t bist_result;<br>
&nbsp; BRCode_t rt;<br>
&nbsp; char * sw_name;<br>
&nbsp; if (!KETHSW_VALID_SWITCH_ID(switch_ID))<br>
&nbsp; {<br>
&nbsp;&nbsp;&nbsp; printf("Invalid switch ID (%d)\n", switch_ID);<br>
&nbsp;&nbsp;&nbsp; return BRC_ERR;<br>
&nbsp; }<br>
<br>
&nbsp; rt = ethsw_bist_run(switch_ID, &amp;bist_result);<br>
&nbsp; <br>
&nbsp; switch (bist_result.device_ID)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33032_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME1;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33036_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME3;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; case ZL_ZL33050_ID:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name =&nbsp;
ETHSW_NAME2;<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp; &nbsp; default:<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sw_name = "Unknown
switch !";<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
<br>
<font color="#ff0000">&nbsp; printf("BIST result:\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;
Device ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : %s (0x%x)\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;
Device revision: %d\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;
RAM status&nbsp;&nbsp;&nbsp;&nbsp; : %s\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "&nbsp;&nbsp;&nbsp;
BIST result&nbsp;&nbsp;&nbsp; : %s\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "\n!! Warning: Switch
has been stopped and restarted to run
BIST !!\n"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sw_name,bist_result.device_ID,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
bist_result.device_revision,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(bist_result.RAM_OK)?"OK" :"KO",<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (rt == BRC_OK)?"OK"
:"KO"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );</font><br>
&nbsp; <br>
&nbsp; return rt;<br>
}<br>
</tt><br>
<h2>Conclusion</h2>
The preceding applies to all the <span style="font-style: italic;">printf()</span>
family routines... Note that
some functions may be limited to 4KB of displayed data in one shot.<br>
<br>
Of course, this is not a revolution. We will not definitely solve the
memory space and performance problems that we may face but it is so
simple to do that it is worth it !<br>
<br>
<br>
<h2>Some interesting links</h2>
<ul>
  <li>This article presents how GCC optimizes the calls to printf() : <a
 class="moz-txt-link-freetext"
 href="http://www.ciselant.de/projects/gcc_printf/gcc_printf.html">http://www.ciselant.de/projects/gcc_printf/gcc_printf.html</a>
  </li>
</ul>
<br>
<h2>About the
author</h2>
The author is an engineer in computer sciences located in France. He
can be contacted <a
 href="http://rachid.koucha.free.fr/contact/contact.html">here</a> or
you can have
a look at his <a href="http://rachid.koucha.free.fr/">WEB
home page</a>.<br>
<br>
<table
 style="text-align: left; margin-left: auto; margin-right: auto; background-color: rgb(192, 192, 192);">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript"
 src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<div style="text-align: right;"><small><a
 href="../technical_documents.html">Go back to previous page</a></small><br>
<small><a href="../../index.html">Go back to home page</a></small><br>
</div>
<br>
<br>
<br>
</body>
</html>
