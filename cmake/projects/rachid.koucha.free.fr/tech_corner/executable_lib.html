<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>


  <meta http-equiv="content-type" content="text/html; charset=UTF-8"><title>How to make executable shared libraries</title>
  
  <meta name="description" content="This paper focuses on the recipe to make executable shared libraries in Linux.">
  <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
  <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script></head><body>
<small><a href="../technical_documents.html">Go back to previous page</a><br>
<a href="../index.html">Go back to home page</a></small><br>
<br>
<small><small><span style="text-decoration: underline;">Last update</span>:
27-Dec-2011<br>
<span style="text-decoration: underline;">Author</span>: R. Koucha</small></small><br>
<h1 style="text-align: center;"><span style="font-style: italic;"></span>How
to
make
executable
shared libraries<br>
</h1>
<br>
<table style="text-align: left; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<table style="text-align: left; width: 100%;" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top; height: 50%; width: 50%;"><br>
      </td>
      <td style="vertical-align: top;"><iframe src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fexecutable_lib.html&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light&amp;height=80" style="border: medium none ; overflow: hidden; width: 450px; height: 80px;" allowtransparency="true" frameborder="0" scrolling="no"></iframe> <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><g:plusone size="medium"></g:plusone>
      <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><a href="mailto:?body=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fexecutable_lib.html&amp;subject=How%20to%20make%20executable%20shared%20libraries%20?"><img alt="s" src="../send_to_a_friend.gif" style="border: 0px solid ; width: 30px; height: 21px;"></a></td>
    </tr>
  </tbody>
</table>
<br>
<br>
<a href="#Introduction">Introduction</a><br>
<a href="#Example_of_shared_library">Example of shared library</a><br>
<a href="#Making_a_executable_shared_library">Making an executable
shared library</a><br>
<a href="#References">References</a><br>
<a href="#About_the_author">About the
author</a><br>
<br>
<h2><a name="Introduction"></a>Introduction</h2>
You may know that it is possible to run the C shared library. For
example, on my Linux system, if I run it, it displays its version:<br>
<br>
<span style="font-family: monospace;">$ /lib/libc.so.6 </span><br style="font-family: monospace;">
<span style="font-family: monospace;">GNU C Library (Ubuntu EGLIBC
2.11.1-0ubuntu7.8) stable release version 2.11.1, by Roland McGrath et
al.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">Copyright (C) 2009 Free Software
Foundation, Inc.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">This is free software; see the
source for copying conditions.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">There is NO warranty; not even
for MERCHANTABILITY or FITNESS FOR A</span><br style="font-family: monospace;">
<span style="font-family: monospace;">PARTICULAR PURPOSE.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">Compiled by GNU CC version 4.4.3.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">Compiled on a Linux
&gt;&gt;2.6.24-27-server&lt;&lt; system on 2011-01-21.</span><br style="font-family: monospace;">
<span style="font-family: monospace;">Available extensions:</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
crypt
add-on
version
2.1 by Michael Glad and others</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
GNU
Libidn
by
Simon Josefsson</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Native
POSIX
Threads
Library by Ulrich Drepper et al</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
BIND-8.2.3-T5B</span><br style="font-family: monospace;">
<span style="font-family: monospace;">For bug reporting instructions,
please see:</span><br style="font-family: monospace;">
<span style="font-family: monospace;">&lt;http://www.debian.org/Bugs/&gt;.</span><br>
<br>
This paper focuses on the recipe to make executable shared libraries.<br>
<br>
<h2><a name="Example_of_shared_library"></a>Example of shared library</h2>
Here is the source file of a shared library:<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="text-align: center; vertical-align: middle;"><big><span style="font-family: monospace; font-weight: bold;">service.c</span></big><br>
      </td>
    </tr>
    <tr style="font-family: monospace;">
      <td style="vertical-align: top;">#include &lt;stdio.h&gt;<br>
      <br>
void lib_service(void)<br>
{<br>
      <br>
&nbsp; printf("This is a service of the shared library\n");<br>
      <br>
} // lib_service<br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Here is a main program which uses the preceding shared library:<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="text-align: center; vertical-align: middle;"><big><span style="font-family: monospace; font-weight: bold;">main.c</span></big><br>
      </td>
    </tr>
    <tr style="font-family: monospace;">
      <td style="vertical-align: top;">#include &lt;stdio.h&gt;<br>
      <br>
extern void lib_service(void);<br>
      <br>
int main(int ac, char *av[])<br>
{<br>
      <br>
&nbsp; lib_service();<br>
      <br>
&nbsp; return 0;<br>
} // main<br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
To build this program along with its shared library, we do:<br>
<br>
<span style="font-family: monospace;">$ gcc -shared service.c -o
libservice.so -Wl,-soname,libservice.so</span><br style="font-family: monospace;">
<span style="font-family: monospace;">$ gcc main.c -o main -lservice -L.</span><br style="font-family: monospace;">
<br>
To run the program we do:<br>
<br>
<span style="font-family: monospace;">$ export
LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:`pwd`</span><br style="font-family: monospace;">
<span style="font-family: monospace;">$ ./main</span><br style="font-family: monospace;">
<span style="font-family: monospace;">This is a service of the shared
library</span><br>
<br>
If we run the library we get a segmentation fault:<br>
<br>
<span style="font-family: monospace;">$ chmod +x ./libservice.so </span><br>
<span style="font-family: monospace;">$ ./libservice.so </span><br style="font-family: monospace;">
<span style="font-family: monospace;">Erreur de segmentation</span><br>
<br>
<h2><a name="Making_a_executable_shared_library"></a>Making an
executable shared library</h2>
We must first specify an entry point for the library:<br>
<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="text-align: center; vertical-align: middle;"><big><span style="font-family: monospace; font-weight: bold;">service.c</span></big><br>
      </td>
    </tr>
    <tr style="font-family: monospace;">
      <td style="vertical-align: top;">#include &lt;stdio.h&gt;<br>
      <br>
void lib_service(void)<br>
{<br>
      <br>
&nbsp; printf("This is a service of the shared library\n");<br>
      <br>
} // lib_service<br>
      <br>
      <br>
void lib_entry(void)<br>
{<br>
&nbsp; printf("Entry point of the service library\n");<br>
}<br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
This entry point is set into the object thanks to the "-e" option of
the linker:<br>
<br>
<span style="font-family: monospace;">$ gcc -shared service.c -o
libservice.so -Wl,-soname,libservice.so -Wl,-e,lib_entry</span><br style="font-family: monospace;">
<br>
But the execution still fails:<br>
<br>
<span style="font-family: monospace;">$ ./libservice.so </span><br style="font-family: monospace;">
<span style="font-family: monospace;">Illegal instruction</span><br style="font-family: monospace;">
<br>
We must make the entry point be a "no return" function thanks to the
"_exit()" service:<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="text-align: center; vertical-align: middle;"><big><span style="font-family: monospace; font-weight: bold;">service.c</span></big><br>
      </td>
    </tr>
    <tr style="font-family: monospace;">
      <td style="vertical-align: top;">#include &lt;stdio.h&gt;<br>
      <span style="color: rgb(255, 0, 0);">#include &lt;unistd.h&gt;</span><br>
      <br>
void lib_service(void)<br>
{<br>
      <br>
&nbsp; printf("This is a service of the shared library\n");<br>
      <br>
} // lib_service<br>
      <br>
      <br>
void lib_entry(void)<br>
{<br>
&nbsp; printf("Entry point of the service library\n");<br>
      <br>
&nbsp; <span style="color: rgb(255, 0, 0);">_exit(0);</span><br>
}<br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
But the execution still fails:<br>
<br>
<span style="font-family: monospace;">$ </span><span style="font-family: monospace;">gcc -shared service.c -o libservice.so
-Wl,-soname,libservice.so -Wl,-e,lib_entry</span><br>
<span style="font-family: monospace;">$ ./libservice.so </span><br style="font-family: monospace;">
<span style="font-family: monospace;">Illegal instruction</span><br>
<br>
We specify the interpreter file to be the dynamic linker. On our Linux
system, it is "/lib/ld-linux.so.2":<br>
<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="text-align: center; vertical-align: middle;"><big><span style="font-family: monospace; font-weight: bold;">service.c</span></big><br>
      </td>
    </tr>
    <tr style="font-family: monospace;">
      <td style="vertical-align: top;">#include &lt;stdio.h&gt;<br>
      <span style="color: rgb(255, 0, 0);">#include &lt;unistd.h&gt;</span><br>
      <br>
      <br>
      <span style="color: rgb(255, 0, 0);">const char service_interp[]
__attribute__((section(".interp"))) = "/lib/ld-linux.so.2";</span><br style="color: rgb(255, 0, 0);">
      <br>
void lib_service(void)<br>
{<br>
      <br>
&nbsp; printf("This is a service of the shared library\n");<br>
      <br>
} // lib_service<br>
      <br>
      <br>
void lib_entry(void)<br>
{<br>
&nbsp; printf("Entry point of the service library\n");<br>
      <br>
&nbsp; <span style="color: rgb(255, 0, 0);">_exit(0);</span><br>
}<br>
      <br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
Now it works !<br>
<br>
<span style="font-family: monospace;">$ </span><span style="font-family: monospace;">gcc -shared service.c -o libservice.so
-Wl,-soname,libservice.so -Wl,-e,lib_entry</span><br>
<span style="font-family: monospace;">$ ./libservice.so</span><br style="font-family: monospace;">
<span style="font-family: monospace;">Entry point of the service library</span><br style="font-family: monospace;">
<br>
Although, it is executable, the file is still usable as a library since
the "main" executable can still dynamically link with it:<br>
<br>
<span style="font-family: monospace;">$ ./main</span><br style="font-family: monospace;">
<span style="font-family: monospace;">This is a service of the shared
library</span><br>
<br>
<br>
<h2><a name="References"></a>References</h2>
<ul>
  <li><a href="./shared_libs_tests.html">How to make and manage shared
objects
in GNU/Linux
environment</a></li>
</ul>
<h2><a name="About_the_author"></a>About the
author</h2>
The author is an engineer in computer sciences located in France. He
can be contacted <a href="http://rachid.koucha.free.fr/contact/contact.html">here</a> or
you can have
a look at his <a href="http://rachid.koucha.free.fr/">WEB
home page</a>.<br>
<br>
<br>
<table style="text-align: left; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<div style="text-align: right;"><small><a href="../technical_documents.html">Go back to previous page</a></small><br>
<small><a href="../index.html">Go back to home page</a></small><br>
</div>
<br>
<br>

</body></html>a></small><br>
</div>
<br>
<br>
</body>
</html>
