<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>



  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>API pour clients FTP, ROOF</title>
  
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=ISO-8859-1">
  <meta name="author" content="rachid koucha">
  <meta name="Category" content="FTP, file transfer protocol, ROOF, RFC959, FUSE">
  <meta name="language" content="fr">
  <meta http-equiv="Content-Language" content="fr">
  <meta name="description" content="Introduction au protocole FTP et description du code source de ROOF">
  <meta name="keywords" content="FTP, file transfer protocol, ROOF, RFC959, fuse, linux">
  <meta name="GENERATOR" content="OpenOffice.org 2.3 (Linux)">
  <style type="text/css">
<!--
@page { size: 21cm 29.7cm; margin: 2cm }
P { margin-bottom: 0.21cm }
H1.western { font-family: "Tahoma", sans-serif; font-size: 16pt; font-weight: medium }
H1.cjk { font-family: "Lucida Sans Unicode" }
H1.ctl { font-family: "Tahoma" }
H2.western { font-family: "Tahoma", sans-serif; font-size: 14pt; font-weight: medium }
H2.cjk { font-family: "Lucida Sans Unicode" }
H2.ctl { font-family: "Tahoma" }
-->
  </style>
  <script type="text/javascript" src="https://apis.google.com/js/plusone.js">
  {lang: 'fr'}
  </script></head><body>
<small><small><span style="text-decoration: underline;">Author</span>:
R. Koucha<br>
<span style="text-decoration: underline;">Last update</span>:
02-Jan-2009</small></small><small><br>
<br>
<a href="../index.html">Page principale</a><br>
<a href="../documents_techniques.html">Page précédente</a></small><br>
<br>
<div style="text-align: center;"><font face="Arial Black, sans-serif"><font size="6"><b>Développement
d'une API pour clients FTP<br>
<br>
</b></font></font></div>
<table style="background-color: silver; text-align: left; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<table style="text-align: left; width: 100%;" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top; height: 50%; width: 50%;"><br>
      </td>
      <td style="vertical-align: top;"><iframe src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fftp_api_fr.html&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light&amp;height=80" style="border: medium none ; overflow: hidden; width: 450px; height: 80px;" allowtransparency="true" frameborder="0" scrolling="no"></iframe> <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><g:plusone size="medium"></g:plusone>
      <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;"><br>
      </td>
      <td style="vertical-align: top;"><a href="mailto:?body=http%3A%2F%2Frachid.koucha.free.fr%2Ftech_corner%2Fftp_api_fr.html&amp;subject=Developpement%20d%27une%20API%20pour%20clients%20FTP"><img alt="s" src="../send_to_a_friend.gif" style="border: 0px solid ; width: 30px; height: 21px;"></a></td>
    </tr>
  </tbody>
</table>
<br>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial Black, sans-serif"><font style="font-size: 11pt;" size="2"><i><b>De
nombreux logiciels ont besoin de télécharger des
fichiers à distance. Dans ce domaine, l'un des protocoles les
plus anciens mais aussi le plus couramment utilisé est File
Transfer Protocol (FTP). Après un rapide survol de la
recommandation, cet article présente le développement
d'une API écrite en langage C pour faciliter la mise en oeuvre
d'un client FTP au sein des logiciels.</b></i></font></font></p>
<a href="#Avant_propos"><span class="western">Avant
propos</span></a><br>
<a href="#1._Survol_de_la_recommandation_FTP">1. Survol de
la recommandation FTP</a><br>
<div style="margin-left: 40px;"><a href="#1.1._Le_modele_client-serveur">1.1.
Le
modèle
client-serveur</a><br>
<a href="#1.2._Les_canaux_de_communication">1.2. Les
canaux de communication</a><br>
<a href="#1.3._Modes_actif_et_passif">1.3. Modes actif et
passif</a><br>
<a href="#1.4._Les_commandes">1.4. Les commandes</a><br>
<a href="#1.5._Les_reponses">1.5. Les réponses</a><br>
</div>
<a href="#2._LAPI">2. L'API</a><br>
<div style="margin-left: 40px;"><a href="#2.1._Installation_de_ROOF">2.1.
Installation
de
ROOF</a><br>
<a href="#2.2._Initialisation">2.2. Initialisation</a><br>
<a href="#2.3._Le_contexte">2.3. Le contexte</a><br>
<a href="#2.4._Lectureecriture_sur_le_reseau">2.4.
Lecture/écriture sur le réseau</a><br>
<a href="#2.5._Envoi_dune_commande">2.5. Envoi d'une
commande</a><br>
<a href="#2.6._Reception_dune_reponse">2.6. Réception
d'une réponse</a><br>
<a href="#2.7._Connexion_au_serveur">2.7. Connexion au
serveur</a><br>
<a href="#2.8._Diagramme_numero_1">2.8. Diagramme numéro 1</a><br>
<a href="#2.9._Diagramme_numero_2">2.9. Diagramme numéro 2</a><br>
<a href="#2.10._Diagramme_numero_3">2.10. Diagramme numéro
3</a><br>
</div>
<a href="#3._Exemple_dutilisation_de_lAPI">3. Exemple
d'utilisation de l'API</a><br>
<a href="#4._Conclusion">4. Conclusion</a><br>
<a href="#Liens">Liens</a><br>
<a href="#References">Références</a><br>
<a href="#A_propos_de_lauteur">A
propos de l'auteur</a><br>
<h2><a name="Avant_propos"></a><span class="western">Avant propos</span></h2>
<font face="Arial, sans-serif"><font size="2">Cet
article a été publié dans <a href="http://www.unixgarden.com/index.php/gnu-linux-magazine/developpement-d-une-api-pour-clients-ftp"><span style="text-decoration: underline;"><img alt="glmf_logo" src="../glmf_logo.jpg" style="border: 0px solid ; width: 100px; height: 30px;"></span></a> numéro 103.<br>
</font></font>
<h1 class="western"><a name="1._Survol_de_la_recommandation_FTP"></a>1.
Survol de la recommandation FTP</h1>
<h2 class="western"><a name="1.1._Le_modele_client-serveur"></a>1.1. Le
modèle client-serveur</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">Le
protocole <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
spécifié dans la <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>&nbsp;<span style=""></span>a été
conçu pour:</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">1.
Faciliter le partage
de fichiers.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">2.
Encourager
l'utilisation de machines distantes.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">3.
Rendre un programme
indépendant des spécificités de gestion des
fichiers sur les systèmes distants.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">4.
Transférer des
données efficacement et de manière sûre.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">C'est
un modèle
client-serveur s'appuyant sur les couches <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>IP</b></font></font>
comme indiqué en <a href="#Figure_1">figure 1</a>.</font></font></p>
<br>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_1"></a>Figure
1&nbsp;:
Architecture
d'un
client-serveur
FTP</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 776px; height: 509px;" alt="figure_1" src="ftp_api_fr_figure_1.jpg"></i></font></font></p>
<h2 class="western"><a name="1.2._Les_canaux_de_communication"></a>1.2.
Les
canaux de communication</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">L'établissement
d'une connexion <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
consiste, pour le client, à ouvrir un canal de contrôle.
Ensuite, un canal de données est éventuellement ouvert.
Le canal de contrôle sert au transfert des commandes, des
réponses aux commandes et des messages spontanés. Le
canal de données n'est établi que si les commandes
engendrent un transfert de données.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
communication sur le
canal de contrôle est bidirectionnelle et conforme au protocole
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>telnet</b></font></font>
décrit dans la <a href="http://www.ietf.org/rfc/rfc854.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC854</b></font></font></a>.
Dans la pratique, <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>telnet</b></font></font>
est utilisé de manière très basique. Le dialogue
est alterné dans le sens où le client envoie une
commande à laquelle le serveur répond par un ou
plusieurs messages. Chaque commande a une liste
prédéfinie
de réponses possibles. Le serveur peut aussi envoyer des
messages spontanés pour fournir des informations diverses
telles que «&nbsp;le système va s'arrêter dans 15
minutes&nbsp;» ou «&nbsp;le délai de connexion est
expiré&nbsp;».</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
communication sur le
canal de données est unidirectionnelle. Le sens de
communication dépend du type de commande en exécution.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Un
canal est en fait une
connexion <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
comme illustré en <a href="#Figure_2">figure 2</a>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2"><br>
</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_2"></a>Figure
2&nbsp;:
Les canaux de communication</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img src="ftp_api_fr_figure_2.jpg" alt="figure_2" style="width: 984px; height: 209px;"></i></font></font></p>
<h2 class="western"><a name="1.3._Modes_actif_et_passif"></a>1.3.
Modes actif et passif</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Par
défaut, le
client demande l'ouverture du canal de contrôle sur le port <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
21 de la machine serveur. Cela suppose que le serveur <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
est en écoute sur ce port. Les valeurs par défaut des
ports pour les deux canaux sont consignées dans le fichier
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>/etc/services</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$
cat /etc/services | grep ftp<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">ftp-data
20/tcp<br>
ftp 21/tcp</font></font><br>
tftp 69/udp<br>
sftp 115/tcp<br>
ftps-data
989/tcp # FTP over SSL (data)<br>
[...]<br>
$</font></p>
      </td>
    </tr>
  </tbody>
</table>
<br>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">L'établissement
du
canal
de
données
dépend
du
mode
de
fonctionnement du
serveur&nbsp;: actif ou passif.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">En
mode actif, le serveur
établit le canal de données sur le port du client qui
est par défaut, le port qu'il a utilisé pour la
connexion de contrôle. Le client a la possibilité de
notifier au serveur un port de données différent par la
commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PORT</b></font></font>.
En pratique, le mode actif est peu utilisé car souvent non
supporté par les clients. De plus, si la machine sur laquelle
le client s'exécute est protégée par un
pare-feu, il y a de grandes chances que le serveur ne pourra pas
établir de connexion sur le port du client.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">En
mode passif, le client
établit le canal de données en utilisant la commande
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font>
pour demander au serveur de proposer un numéro de port <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
sur lequel le client établira un canal de données. Ce
mode simplifie l'écriture des clients et sera celui
utilisé
par l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
présentée dans la suite.</font></font></p>
<h2 class="western"><a name="1.4._Les_commandes"></a>1.4.
Les commandes</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Les
commandes sont des
lignes de données <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ASCII</b></font></font>
au format&nbsp;:</font></font></p>
<p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>Commande
paramètre1 paramètre2... CRLF</b></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
commande est un mot de
4 caractères au maximum. Les majuscules et minuscules peuvent
être utilisées de manière indifférente.
Les paramètres peuvent ne pas apparaître si la commande
n'en nécessite pas ou s'ils sont optionnels.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Les
commandes les plus
couramment utilisées sont décrites dans le <a href="#Tableau_1">tableau
1</a>
(les paramètres décrits entre crochets sont facultatifs
et les commandes marquées d'un astérisque font partie
de l'ensemble minimum qu'un serveur FTP doit supporter pour être
considéré conforme à la recommandation).</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Tableau_1"></a>Tableau
1 :
Liste des commandes <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
les plus usitées</i></font></font></p>
<table border="1" bordercolor="#000000" cellpadding="4" cellspacing="0" width="100%">
  <col width="32*"> <col width="39*"> <col width="185*"> <tbody>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="center"> <font face="Arial, sans-serif"><font size="2">Nom de
commande</font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="center"> <font face="Arial, sans-serif"><font size="2">Paramètres</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="center"> <font face="Arial, sans-serif"><font size="2">Description</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">nom_utilisateur</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">C'est
la première commande envoyée au serveur pour
identifier l'utilisateur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASS</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">mot_de_passe</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Envoie
un mot de passe au serveur si le nom
d'utilisateur spécifié par la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
en nécessite un. On remarquera au passage le principal reproche
fait à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP&nbsp;</b></font></font>:
les mots de passe circulent en clair sur le réseau.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CWD</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">répertoire</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Changement
de
répertoire
de
travail
encore
appelé
répertoire
courant.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CDUP</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">C'est
un raccourci de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CWD</b></font></font>
pour aller dans le répertoire père du répertoire
courant. Sur Unix,
c'est équivalent à la commande Shell <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>cd ..</b></font></font>
mais pour d'autres systèmes, cela peut être
différent. D'où l'intérêt
de cette commande pour ignorer les spécificités d'un
système à l'autre.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>QUIT (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Déconnecte
l'utilisateur
courant
et
ferme
le
canal
de
contrôle.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>REIN</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Déconnecte
l'utilisateur
mais
à
la
différence
de

      <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>QUIT</b></font></font>,
le canal de contrôle reste ouvert pour accepter une nouvelle
commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
afin de connecter un nouvel utilisateur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PORT (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">port_TCP</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Le
client indique au serveur le numéro de port <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
sur lequel il attend l'établissement du canal de
données&nbsp;: le
serveur est en mode actif.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">C'est
l'opposée de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PORT</b></font></font>.
Le client demande au serveur un numéro de port <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
sur lequel le client établira le canal de données&nbsp;:
le serveur
est en mode passif.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TYPE (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">type</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Indique
le
type
des
informations
transférées
sur
le
canal
de données. Parmi les différents choix possibles,
les plus
utilisés et souvent les seuls supportés par les serveurs,
sont le type <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ASCII</b></font></font>
(type = A) et le type binaire (type = I).</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STRU (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">structure</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Date
de l'époque où certains systèmes
d'exploitation structuraient leurs fichiers en pages ou enregistrements
pour optimiser les temps de traitement. Cette commande est aussi utile
pour l'implémentation de la reprise sur erreur. La structure par
défaut
est fichier (structure = F).</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>MODE (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">mode</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Indique
le
mode
de
transfert
des
données.
Cette
commande
est aussi utile pour l'implémentation de la reprise sur
erreur. Le mode par défaut est stream (mode = S).</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RETR (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">fichier</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
le
transfert
d'un
fichier
du
serveur
vers
le
client.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STOR (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">fichier</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
le
transfert
d'un
fichier
du
client
vers
le
serveur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNFR</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">fichier</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
le
renommage
d'un
fichier
sur
le
serveur.
Cette
commande spécifie le nom du fichier source et est suivie
de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNTO</b></font></font>
pour le nom du fichier destination.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNTO</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">fichier</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Cf. <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNFR</b></font></font></font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ABOR</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
l'arrêt
de
la
commande
en
cours.
Si
un
canal de données est ouvert, il est fermé par le serveur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>DELE</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">fichier</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
la
destruction
d'un
fichier
sur
le
serveur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RMD</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">répertoire</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
la
destruction
d'un
répertoire
sur
le
serveur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>MKD</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">répertoire</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
la
création
d'un
répertoire
sur
le
serveur.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PWD</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
au
serveur
le
nom
du
répertoire
courant.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LIST</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">[répertoire]</font></font></p>
      <p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
      <font face="Arial, sans-serif"><font size="2">ou</font></font></p>
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">[fichier]</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
au
serveur
les
informations
afférentes
à
un
fichier
ou tous les fichiers d'un répertoire (nom, droits, date
de
création, taille...). Par défaut, ce sont les fichiers du
répertoire
courant. Sur Unix, c'est normalement le résultat de la commande
Shell <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ls -l</b></font></font>
mais sur d'autres systèmes cela peut être différent.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NLST</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">[répertoire]</font></font></p>
      <p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
      <font face="Arial, sans-serif"><font size="2">ou</font></font></p>
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">[fichier]</font></font></p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Cette
commande a le même comportement que la
commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LIST</b></font></font>
mais ne liste que le nom des fichiers. L'avantage par rapport à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LIST</b></font></font>
est d'avoir le même résultat quelque soit le
système de fichiers côté
serveur. Sur Unix, c'est normalement le résultat de la commande
Shell <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ls -a</b></font></font>.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SYST</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Demande
au
serveur
d'identifier
son
système
d'exploitation.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="12%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NOOP (*)</b></font></font></font></font></p>
      </td>
      <td width="15%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><br>
      </p>
      </td>
      <td width="72%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="justify"> <font face="Arial, sans-serif"><font size="2">Ne
provoque aucune action sauf de demander au
serveur de répondre OK. Cela peut servir à maintenir du
trafic avec un
serveur qui implémente un délai maximum
d'inactivité avant déconnexion
automatique.</font></font></p>
      </td>
    </tr>
  </tbody>
</table>
<h2 class="western"><a name="1.5._Les_reponses"></a>1.5.
Les réponses</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Une
réponse est
codée comme suit&nbsp;:</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">-
La première
ligne commence par un code à trois digits <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>xyz</b></font></font>
immédiatement suivi d'un tiret éventuellement suivi
d'un texte et terminée par les caractères <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LF</b></font></font>;</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">-
Les lignes suivantes
contiennent du texte quelconque et sont terminées par les
caractères <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LF</b></font></font></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; margin-left: 40px;" align="justify">
<font face="Arial, sans-serif"><font size="2">-
La dernière
ligne commence par le code à trois digits <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>xyz</b></font></font>
de la première ligne suivi d'un caractère espace
éventuellement suivi d'un texte et terminée par les
caractères <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LF</b></font></font>.
Si la réponse est monoligne, elle suit ce codage.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>xyz</b></font></font>
sont 3 digits qui indiquent l'état d'avancement de la commande
en cours. Le principe de codage des digits va du général
au particulier&nbsp;: le premier digit donne une information qui
est
explicitée avec les deux digits qui suivent. Le <a href="#Tableau_2">tableau
2</a>
donne les valeurs possibles pour le premier digit. La recommandation
spécifie une liste de valeurs possibles pour les digits qui
suivent mais il n'est pas utile de les citer ici d'autant plus que
nous verrons dans l'implémentation de l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
qu'il est possible d'implémenter le protocole en ne tenant
compte que de la valeur du premier digit.</font></font></p>
<p style="margin-bottom: 0cm; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Tableau_2"></a>Tableau
2
:
Les
valeurs
du
premier
digit
dans
les réponses</i></font></font></p>
<table border="1" bordercolor="#000000" cellpadding="4" cellspacing="0" width="100%">
  <col width="20*"> <col width="236*"> <tbody>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="center"> <font face="Arial, sans-serif"><font size="2">Valeur</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;" align="center"> <font face="Arial, sans-serif"><font size="2">Description</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">1yz</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Réponse
préliminaire positive&nbsp;: indique que la commande a
été acceptée.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">2yz</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Terminaison
positive&nbsp;: l'action a été exécutée
correctement, une nouvelle
action peut être engagée.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">3yz</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Réponse
positive intermédiaire&nbsp;: la commande a été
acceptée mais est
en attente d'informations supplémentaires. Cela est
utilisé pour les
commandes groupées (e.g. <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNFR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNTO</b></font></font>).</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">4yz</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Terminaison
négative transitoire&nbsp;: la commande n'a pas
été acceptée mais
la situation d'erreur est temporaire et la commande peut donc
être
relancée.</font></font></p>
      </td>
    </tr>
    <tr valign="top">
      <td width="8%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">5yz</font></font></p>
      </td>
      <td width="92%">
      <p style="margin-top: 0.2cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Terminaison
négative permanente&nbsp;: la commande n'est pas acceptable en
l'état.</font></font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
</p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Le texte
qui suit les
digits dans les lignes de réponses est facultatif et souvent
présent à titre d'information à l'exception de
certaines commandes comme <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font>
qui impliquent une réponse avec un texte formaté. Le
texte peut être composé de plusieurs lignes. </font></font>
</p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Les
réponses sont
la plupart du temps monolignes. Voici par exemple la réponse
d'un serveur quand il demande le mot de passe d'un
utilisateur&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td><font style="font-size: 9pt;" size="2">331
Password required for foo.</font></td>
    </tr>
  </tbody>
</table>
<br>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Dans
ce cas, le code 3
indique que le serveur a accepté la commande
précédente
et est en attente d'informations supplémentaires&nbsp;: le mot
de passe.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Les
réponses
multilignes ne sont généralement utilisées que
pour afficher les bannières d'accueil lorsque le client se
connecte (fichier <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>/etc/ftpwelcome</b></font></font>).
A
titre
d'exemple,
nous
présentons
la
bannière
émise
par
un serveur <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
tournant sur un système Linux après la phase
d'identification du client. Le code suivi d'un tiret est affiché
sur les lignes intermédiaires mais ce n'est pas obligatoire
selon la recommandation. On notera surtout le code 230 suivi d'un
tiret en première ligne et le même code 230 suivi d'un
caractère espace en dernière ligne&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;" align="justify"><font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">230-</font></font>
Linux toto-host 2.6.22-14-generic #1 SMP Tue Dec 18 08:02:57 UTC 2007
i686<br>
230-<br>
230-
The programs included with the Ubuntu system are free software;<br>
230-
the exact distribution terms for each program are described in the<br>
230-
individual files in /usr/share/doc/*/copyright.<br>
230-<br>
230-
Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by<br>
230-
applicable law.<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">230 </font></font><font style="font-size: 9pt;" size="2">User
foo logged in.</font></font></p>
      </td>
    </tr>
  </tbody>
</table>
<span style="font-family: Arial,sans-serif;"><br>
</span>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Dans
ce cas, le code 2
indique que la commande précédente a été
acceptée et qu'une nouvelle commande peut être
lancée.</font></font></p>
<h1 class="western"><a name="2._LAPI"></a>2.
L'API</h1>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Après
ce rapide
passage en revue de la <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>,
il est possible de décrire l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
qui facilite le développement de clients <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>telnet</b></font></font>.
Dans la description en couche du modèle <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>,
l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
est un élément situé juste en dessous du client
comme indiqué en <a href="#Figure_3">figure 3</a>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_3"></a>Figure
3&nbsp;:
L'API dans le modèle FTP</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 776px; height: 472px;" alt="figure_3" src="ftp_api_fr_figure_3.jpg"></i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
nom de cette <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
est <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF</b></font></font>
(pour «&nbsp;<b>R</b>emote <b>O</b>perations
<b>O</b>n
<b>F</b>iles&nbsp;»). Elle se présente sous la forme
d'une librairie partagée disponible en «&nbsp;open
source&nbsp;» et hébergée sur <a href="http://roof.sourceforge.net/">sourceforge</a>.</font></font></p>
<h2 class="western"><a name="2.1._Installation_de_ROOF"></a>2.1.
Installation de ROOF</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Télécharger
le fichier «&nbsp;.tgz&nbsp;» à partir de
sourceforge. Décompresser le fichier avec la commande&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td><font style="font-size: 9pt;" size="2">$
tar xvfz roofxxx.tgz</font></td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">L'arborescence
se
présente
comme
indiqué
en
<a href="#Figure_4">figure 4</a>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_4"></a>Figure
4&nbsp;:
L'arborescence de l'API</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial, sans-serif"><font size="2"><img style="width: 530px; height: 288px;" alt="figure_4" src="ftp_api_fr_figure_4.jpg"></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Le
répertoire
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>include</b></font></font>
contient le fichier <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof.h</b></font></font>
dans lequel sont définis les services et structures de
données
publiques. Ce fichier devra être inclus par tout utilisateur de
la librairie.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
répertoire <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>lib</b></font></font>
contient l'implémentation de la librairie <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>libroof.so</b></font></font>
qui sera lié dynamiquement avec le programme utilisateur. Les
fichiers sont <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof.c</b></font></font>
pour l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_p.h</b></font></font>
pour les définitions internes.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
répertoire
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>client</b></font></font>
contient un exemple de client <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
qui utilise l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>&nbsp;:
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
répertoire <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>man</b></font></font>
contient les manuels en ligne de la librairie. Le manuel se
répartit
dans les sections 1 (commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof</b></font></font>
pour le client), 3 (<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>)
et 7 (description générale).</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
processus de
génération utilise un script appelé
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_install.sh</b></font></font>
basé sur <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>cmake</b></font></font>
([4] et [6]) qu'il faut donc avoir installé sur son
système.
Ici est montré comment générer et installer
à
l'aide de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>cmake</b></font></font>
dans le répertoire par défaut <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>/usr/local</b></font></font>
(l'installation recquiert les droits du super utilisateur)&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$ <font color="#ff0000"><font style="font-size: 9pt;" size="2">cd
roofxxx</font></font><br>
$ <font color="#ff0000"><font style="font-size: 9pt;" size="2">cmake
.</font></font><br>
--
Check for working C compiler: /usr/bin/gcc<br>
[...]<br>
--
Build files have been written to: [...]<br>
$ <font color="#ff0000"><font style="font-size: 9pt;" size="2">make</font></font><br>
[...]<br>
Linking
C executable roof<br>
[...]<br>
$ <font color="#ff0000"><font style="font-size: 9pt;" size="2">sudo
make install</font></font><br>
[...]<br>
Linking
C executable CMakeFiles/CMakeRelink.dir/roof<br>
Install
the project...<br>
[...]</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Pour
vérifier
l'installation, consulter un manuel en ligne de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof</b></font></font>
(en mettant éventuellement à jour la variable
d'environnement <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>MANPATH</b></font></font>
avec <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>/usr/loca/man</b></font></font>)&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$
man 3 roof<br>
ROOF(3)
Linux Programmer&#8217;s Manual ROOF(3)</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <br>
      <font style="font-size: 9pt;" size="2">NAME<br>
roof
- API for Remote Operations On Files<br>
[...]</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Il
est aussi possible de
tester l'exécutable <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof</b></font></font>
(en mettant éventuellement à jour la variable
d'environnement <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LD_LIBRARY_PATH</b></font></font>
avec <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>/usr/local/lib</b></font></font>
si le liaison dynamique avec <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>libroof.so</b></font></font>
pose problème)&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$
roof<br>
roof
1.5<br>
[...]<br>
Type
'help' or '?' for the list of available commands.</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <br>
      <font style="font-size: 9pt;" size="2">ftp&gt;
quit<br>
$</font></p>
      </td>
    </tr>
  </tbody>
</table>
<br>
<font face="Arial, sans-serif"><font size="2">Dans
la suite de
l'article, sont décrites les parties principales de la
librairie pour comprendre dans le détail le passage de la
recommandation <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>
à l'implémentation. Les extraits de code cités
ont parfois été élagués pour rendre cet
article le plus concis possible. Le lecteur est invité à
télécharger les sources complets à partir de
sourceforge pour avoir tous les détails d'implémentation.<br>
</font></font>
<h2 class="western"><a name="2.2._Initialisation"></a>2.2.
Initialisation</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Pour
être pratique
et robuste, une <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
se doit d'être réentrante de sorte à supporter
plusieurs instances d'exécution en même temps. Cette
précaution trouve toute sa signification quand le logiciel qui
l'utilise est «&nbsp;multithreadé&nbsp;»&nbsp;:
plusieurs threads s'exécutant en parallèle peuvent
utiliser la librairie. Un <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>mutex</b></font></font>
est donc créé et initialisé dans le point
d'entrée de la librairie déclaré comme suit,
pour être identifié et exécuté par le
«&nbsp;linker&nbsp;» dynamique au moment du chargement
(cf. <a href="http://tldp.org/HOWTO/Program-Library-HOWTO/miscellaneous.html#INIT-AND-CLEANUP">[5]</a>
pour plus de détails)&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">void
__attribute__ ((constructor)) roof_initialize(void);</font><br>
      <br>
      <font style="font-size: 9pt;" size="2">void
roof_initialize(void)<br>
{<br>
int
rc;</font><br>
      <br>
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Creation du mutex (non vérouillé)<br>
&nbsp; rc
= pthread_mutex_init(&amp;roof_mtx, NULL);<br>
&nbsp; [...]<br>
}
// roof_initialize</font></p>
      </td>
    </tr>
  </tbody>
</table>
<font face="Arial, sans-serif"><font size="2"><br>
Deux
macros sont définies
pour verrrouiller et déverrouiller le <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>mutex</b></font></font>&nbsp;:<br>
<br>
</font></font>
<table style="text-align: left; background-color: silver; font-family: monospace;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">#define
ROOF_LOCK() (pthread_mutex_lock(&amp;roof_mtx))<br>
#define
ROOF_UNLOCK() (pthread_mutex_unlock(&amp;roof_mtx))</font></p>
      </td>
    </tr>
  </tbody>
</table>
<br>
<h2 class="western"><a name="2.3._Le_contexte"></a>2.3.
Le contexte</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
contexte est une
structure de données qui identifie une instance de la
librairie. Il y a un contexte de type <b>roof_ctx_t </b>par
utilisateur&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">typedef
struct<br>
{<br>
&nbsp; void
*ctx; // Contexte utilisateur<br>
}
roof_ctx_t;</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Le
champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctx</b></font></font>
pointe sur des données privées à l'utilisateur.
La librairie n'a aucune action sur ce pointeur. Cela permet
simplement à l'utilisateur d'associer des données
quelconques à son instance d'exécution dans la
librairie. En interne, le contexte utilisateur est stocké dans
le champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctx</b></font></font>
de la structure <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context_t</b></font></font>
définie comme suit dans <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_p.h</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">typedef
struct<br>
{<br>
&nbsp; unsigned
int &nbsp;debug_level; &nbsp; &nbsp; // Niveau de debug<br>
&nbsp; char
&nbsp; &nbsp; &nbsp; &nbsp; *iobuf; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; // Buffer d'E/S<br>
&nbsp; unsigned
int &nbsp;l_iobuf; &nbsp; &nbsp; &nbsp; &nbsp; //
Taille du buffer d'E/S<br>
&nbsp; void &nbsp; &nbsp; &nbsp; &nbsp; *ctx;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Donnees utilisateur<br>
&nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
busy;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 1,
si contexte occupe<br>
&nbsp; int
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; internal_iobuf;
&nbsp;// 1, si buffer d'E/S alloue en interne<br>
&nbsp; int ctrl;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Socket de la
cnx de controle<br>
&nbsp; unsigned
int &nbsp;timeout_ms; &nbsp; &nbsp; &nbsp;// Timeout
avec le serveur en ms<br>
&nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;type;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//
Type pour la commande TYPE<br>
&nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;code;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//
Code pour la commande TYPE<br>
}
roof_context_t;</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Si
cette structure
apparaîssait dans le fichier header public <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof.h</b></font></font>,
l'utilisateur de la librairie serait tenté d'utiliser les
champs explicitement dans son code. Cela pourrait rendre son
programme incompatible avec de futures versions de la librairie (si
les champs sont renommés ou disparaîssent) et pourrait
porter atteinte à l'intégrité de la librairie
(si les champs sont modifiés à l'insu de l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>).</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Dans
la suite, <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_ctx_t</b></font></font>
sera appelé «&nbsp;<b>contexte externe</b>&nbsp;»
(celui vu par l'utilisateur) et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context_t</b></font></font>
sera appelé «&nbsp;<b>contexte interne</b>&nbsp;»
(celui vu par la librairie). Pour retrouver le second à partir
du premier, la librairie utilise la macro <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_CTX()</b></font></font>
qui retrouve l'adresse du contexte interne à partir de celle
du contexte externe et l'offset du champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctx</b></font></font>
dans la structure <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context_t</b></font></font>&nbsp;:<span style="font-weight: bold;"></span></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2"><span style="font-weight: bold;"></span></font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2">#define
ROOF_CTX(p) ((roof_context_t *) ((char
*)p - offsetof(roof_context_t, ctx)))</font></font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Inversement,
le
contexte
externe
est
retrouvé
à
partir
du
contexte interne
grâce
à la macro <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_EXT_CTX()</b></font></font>
qui ne fait que retourner l'adresse du champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctx</b></font></font>
de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context_t</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver; font-family: monospace;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;"><font style="font-size: 9pt;" size="2">#define
ROOF_EXT_CTX(p) ((roof_ctx_t *)&amp;(p-&gt;ctx))</font></td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
</p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
librairie définit
un nombre maximum de contextes avec la constante <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_NB_MAX_CTX</b></font></font>
qui sert à dimensionner la table des contextes <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context[]</b></font></font>
dans <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof.c</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
toute première
chose à faire pour l'utilisateur de la librairie est de
réserver un contexte à l'aide du service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_new()</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; font-family: monospace; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">roof_ctx_t
*roof_new(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unsigned
int &nbsp;timeout_ms, // Timeout (ms) pour interactions avec le
serveur<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//
0 = Attente infinie<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char
&nbsp; &nbsp; &nbsp; &nbsp; *iobuf, &nbsp;
&nbsp; &nbsp;// Buffer d'E/S (Defaut si NULL)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unsigned
int &nbsp;l_iobuf, &nbsp; &nbsp;// Longueur du buffer d'E/S
(Defaut si 0)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;void &nbsp;
&nbsp; &nbsp; &nbsp; *ctx
&nbsp; &nbsp; &nbsp; &nbsp; // Contexte utilisateur<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; )<br>
{<br>
unsigned
int i;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; ROOF_LOCK();</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
// <font color="#ff0000"><font style="font-size: 9pt;" size="2">Recherche
d'un
contexte
libre</font></font><br>
&nbsp; for
(i = 0; i &lt; ROOF_NB_MAX_CTX; i ++)<br>
&nbsp; {<br>
&nbsp; &nbsp; if
(0 == roof_context[i].busy)<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; roof_context[i].busy
= 1;<br>
&nbsp; &nbsp; &nbsp; break;<br>
&nbsp; &nbsp; }<br>
&nbsp; }
// End for</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; ROOF_UNLOCK();</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(i &gt;= ROOF_NB_MAX_CTX)<br>
&nbsp; {<br>
&nbsp; &nbsp; errno
= ENOSPC;<br>
&nbsp; &nbsp; return
NULL;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
roof_context[i].debug_level
= 0;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
// <font color="#ff0000"><font style="font-size: 9pt;" size="2">Si
buffer alloue par l'utilisateur</font></font><br>
&nbsp; if
(iobuf &amp;&amp; l_iobuf)<br>
&nbsp; {<br>
&nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; roof_context[i].iobuf
= iobuf;<br>
&nbsp; &nbsp; roof_context[i].l_iobuf
= l_iobuf;<br>
&nbsp; &nbsp; roof_context[i].internal_iobuf
= 0;<br>
&nbsp; }<br>
&nbsp; else
// <font color="#ff0000"><font style="font-size: 9pt;" size="2">Buffer
alloue en interne</font></font><br>
&nbsp; {<br>
&nbsp; &nbsp; roof_context[i].iobuf
= (char *)malloc(ROOF_IO_BUF_SIZE);<br>
&nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; roof_context[i].l_iobuf
= ROOF_IO_BUF_SIZE;<br>
&nbsp; &nbsp; roof_context[i].internal_iobuf
= 1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
roof_context[i].ctrl
= -1;<br>
&nbsp; roof_context[i].timeout_ms
= timeout_ms;<br>
&nbsp; roof_context[i].ctx
= ctx;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; return
(roof_ctx_t *)&amp;(roof_context[i].ctx);</font></font><br>
}
// roof_new</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Un
contexte libre (champ
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>busy</b></font></font>
= 0) est recherché dans la table globale des contextes. La
recherche se fait dans une section critique protégée
par le <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>mutex</b></font></font>
(macros <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_LOCK()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_UNLOCK()</b></font></font>)
pour assurer la réentrance. Le contexte trouvé est
initialisé avec les paramètres passés au
service. Le premier paramètre <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>timeout_ms</b></font></font>
est le temps maximum en millisecondes que le service attendra pour
recevoir une réponse de la part du serveur. Il est
conseillé
de le positionner à quelques secondes de sorte à
éviter
d'avoir un programme qui se met en attente infinie si le serveur ne
répond pas. Les paramètres suivants <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>iobuf</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>l_iobuf</b></font></font>
sont respectivement l'adresse et la taille du buffer
d'entrée/sortie
utilisé pour le dialogue avec le serveur. Si l'appelant passe
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NULL</b></font></font>
pour l'adresse ou 0 pour la taille, le buffer sera alloué en
interne par le service avec une taille par défaut de
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_IO_BUF_SIZE</b></font></font>
octets (défini en interne dans <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_p.h</b></font></font>).
La valeur retournée par le service est <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NULL</b></font></font>
en cas d'erreur ou le contexte externe en cas de succès (dans
ce cas c'est l'adresse du champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctx</b></font></font>
de la structure <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_context_t</b></font></font>).
Du point de vue de l'utilisateur, ce contexte est un identifiant
qu'il devra passer à tous les autres services pour identifier
son instance d'exécution.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Losrque
l'utilisateur n'a
plus besoin de son contexte d'exécution, il fait appel à
la fonction <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_delete()</b></font></font>
pour libérer les ressources&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver; font-family: monospace;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">void
roof_delete(roof_ctx_t *pContext) // Contexte externe</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">{<br>
roof_context_t
*<font color="#ff0000"><font style="font-size: 9pt;" size="2">pCtx
= ROOF_CTX(pContext);</font></font><br>
      </font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">&nbsp; //
Desallocation du buffer d'E/S si alloue en interne<br>
&nbsp; if
(pCtx-&gt;<font color="#ff0000"><font style="font-size: 9pt;" size="2">internal_iobuf</font></font>)<br>
&nbsp; {<br>
&nbsp; &nbsp; free(pCtx-&gt;iobuf);<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">&nbsp; // <font color="#ff0000"><font style="font-size: 9pt;" size="2">Fermeture
de socket de controle si ouverte</font></font><br>
&nbsp; if
(pCtx-&gt;<font style="font-size: 9pt;" size="2">ctrl</font>
&gt;= 0)<br>
&nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
shutdown</font></font>(pCtx-&gt;ctrl,
SHUT_RDWR);<br>
&nbsp; &nbsp; close(pCtx-&gt;ctrl);<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">&nbsp;
ROOF_LOCK();</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; pCtx-&gt;busy
= 0;</font></font><br>
      </font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">&nbsp;
ROOF_UNLOCK();</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">}
// roof_delete</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
fonction effectue les
opération inverses à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_new()</b></font></font>.
Le buffer d'entrée/sortie est libéré s'il a
été
alloué en interne (champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>internal_iobuf</b></font></font>
!= 0), la socket sur le canal de contrôle est fermée
«&nbsp;proprement&nbsp;» à l'aide de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>shutdown()</b></font></font>
puis <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>close()</b></font></font>
si elle est ouverte et enfin le champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>busy</b></font></font>
est mis à 0 pour marquer le contexte comme étant libre
pour un nouvel utilisateur.</font></font></p>
<h2 class="western"><a name="2.4._Lectureecriture_sur_le_reseau"></a>2.4.
Lecture/écriture
sur
le
réseau</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
communication avec le
serveur utilise le protocole <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP/IP</b></font></font>
qui est masqué par la librairie <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>socket</b></font></font>
de Linux. Cela permet d'envoyer et recevoir des données sur le
réseau via un descripteur de fichier en utilisant les appels
système classiques <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>read()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>write()</b></font></font>
comme si on écrivait ou lisait un fichier (c'est l'application
du fameux concept de base «&nbsp;tout est fichier&nbsp;»
d'Unix).</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Dans
la librairie, deux
fonctions <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_read()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_write()</b></font></font>
encapsulent les appels systèmes <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>read()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>write()</b></font></font>
pour essentiellement utiliser la notion de contexte où se
trouvent des informations utiles comme le niveau de debug
utilisé
par certaines macros de trace et traiter le retour erreur <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>EINTR</b></font></font>.
Un signal, étant asynchrone, peut survenir à tout
moment et interrompre les instructions en cours pour déclencher
un handler préalablement définie par l'utilisateur pour
le gérer. Il s'avère que sous Linux, la plupart des
appels système retournent en erreur avec la variable <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>errno</b></font></font>
positionnée à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>EINTR</b></font></font>
s'ils sont interrompus par un signal. <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_read()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_write()</b></font></font>
testent donc ce code d'erreur pour réitérer l'appel
système.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Voici
la fonction
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_write()</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">static
int roof_write(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roof_context_t
*pCtx, // Contexte interne<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd, &nbsp;
//
Descripteur de sortie<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const
void &nbsp; &nbsp; *buf, &nbsp;// Buffer d'ecriture<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size_t
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;len
&nbsp; // Nombre d'octets a ecrire<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)<br>
{<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rc;<br>
unsigned
int l;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
l
= len;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
do<br>
&nbsp; {<br>
&nbsp; &nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">write</font></font>(fd,
((const
char
*)buf)
+
(len
-
l),
l);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; if
(rc &lt; 0)<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; if
(<font color="#ff0000"><font style="font-size: 9pt;" size="2">EINTR</font></font>
== errno)<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; //
Reiterer le read()<br>
&nbsp; &nbsp; &nbsp; &nbsp; rc
= 0;<br>
&nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; if
(rc &gt; 0)<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; assert(l
&gt;= (unsigned)rc);<br>
&nbsp; &nbsp; &nbsp; l
-= rc;<br>
&nbsp; &nbsp; }<br>
&nbsp; }
while (l &amp;&amp; (rc &gt;= 0));</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; if
(-1 == rc)<br>
&nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
int
saved_errno
=
errno;</font></font><br>
      </font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; ROOF_ERR(pCtx,
"Error '%s' (%d) on write()\n",<br>
&nbsp; &nbsp; strerror(errno),
errno);<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
errno
=
saved_errno;</font></font><br>
&nbsp; }<br>
&nbsp; else<br>
&nbsp; {<br>
&nbsp; &nbsp; rc
= len;<br>
&nbsp; }</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;return
rc;<br>
}
// roof_write</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Voici
la fonction
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_read()</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver; width: 13px; height: 31px;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">static
int roof_read(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; roof_context_t
*pCtx, // Contexte interne<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; fd, &nbsp; //
Descripteur d'entree<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; *buf,
&nbsp;// Buffer de lecture<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; unsigned
int &nbsp; &nbsp;len &nbsp; // Nombre max d'octets a lire<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; )<br>
{<br>
int
rc;<br>
int
saved_errno;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; do<br>
&nbsp; {<br>
&nbsp; &nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">read</font></font>(fd,
buf,
len);<br>
&nbsp; &nbsp; if
(-1 == rc)<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; if
(<font color="#ff0000"><font style="font-size: 9pt;" size="2">EINTR</font></font>
== errno)<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; continue;<br>
&nbsp; &nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; &nbsp; saved_errno
= errno;</font></font><br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s' (%d) on read(%d)\n", strerror(errno),
errno, fd);<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
errno
=
saved_errno;</font></font></font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; }
while (rc &lt; 0);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
return
rc;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">}
// roof_read</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Dans
les exemples
précédents, la variable <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>errno</b></font></font>
est sauvegardée avant l'appel aux macros de
génération
des messages d'erreur et restaurée après car on veut
préserver la valeur de l'erreur en sortant de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_write()</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_read()</b></font></font>.
La sauvegarde est obligatoire car la macro d'erreur fait appel à
des fonctions de la librairie C telles que <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>printf()</b></font></font>
qui peuvent altérer la valeur de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>errno</b></font></font>.
C'est une méthode préconisée par le manuel en
ligne&nbsp;: <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>man
3 errno</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Ces
fonctions auraient pu
se contenter d'utiliser l'adresse du buffer d'entrée/sortie
stockée dans le contexte interne au lieu de recevoir l'adresse
en paramètre. Mais dans certains cas, elles sont
utilisées
avec un buffer autre que le buffer d'entrée/sortie du contexte
ou alors avec ce buffer mais à un offset donné lors des
lectures des réponses multilignes par exemple.</font></font></p>
<h2 class="western"><a name="2.5._Envoi_dune_commande"></a>2.5.
Envoi d'une commande</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">L'une
des grandes
fonctions du client est d'envoyer des commandes au serveur. Comme il
l'a été vu au <a href="#1.4._Les_commandes">§&nbsp;1.4</a>,
les
commandes
sont
composées
d'un
mot
clé
éventuellement
suivi d'un
paramètre et terminées par les caractères de fin
de ligne <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LF</b></font></font>.
Les commandes sont envoyées par le client sur le canal de
contrôle. C'est la fonction interne <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_send_cmd()</b></font></font>
qui réalise cette opération&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">static
int roof_send_cmd(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;roof_context_t
*pCtx, &nbsp; // Contexte interne<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;const
char &nbsp; &nbsp; *<font color="#ff0000"><font style="font-size: 9pt;" size="2">format</font></font>,
// Commande à envoyer<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;...</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br>
{<br>
int &nbsp; &nbsp; rc = 0;<br>
va_list
args_list;<br>
int &nbsp; &nbsp; sz;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
va_start(args_list,
format);<br>
&nbsp; sz
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">vsnprintf</font></font>(pCtx-&gt;iobuf,
pCtx-&gt;l_iobuf,
format,
args_list);<br>
&nbsp; va_end(args_list);</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; [...]<br>
&nbsp; rc
= roof_write(pCtx, pCtx-&gt;ctrl, pCtx-&gt;iobuf, sz);<br>
&nbsp; [...]</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
return 0;<br>
}
// roof_send_cmd</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
fonction, qui est à
nombre d'arguments variable, reçoit en paramètre une
commande spécifiée par un format à la <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>printf()</b></font></font>
décodé à l'aide du service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>vsnprintf()</b></font></font>
de la librairie C. Cela permet de la rendre générique
afin d'envoyer toute commande avec ou sans paramètres. Par
exemple, pour envoyer une commande sans paramètres comme
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;"><font style="font-size: 9pt;" size="2">rc
= roof_send_cmd(pCtx, "PASV\r\n");</font></td>
    </tr>
  </tbody>
</table>
<span style="font-family: Arial,sans-serif;"><br>
</span>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Et
pour envoyer une
commande avec paramètres comme <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TYPE</b></font></font>&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;"><font style="font-size: 9pt;" size="2">rc
= roof_send_cmd(pCtx, "TYPE %c %c\r\n", type, code);</font></td>
    </tr>
  </tbody>
</table>
<br>
<h2 class="western"><a name="2.6._Reception_dune_reponse"></a>2.6.
Réception
d'une réponse</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">L'autre
grande fonction
du client est de recevoir des réponses de la part du serveur.
Comme indiqué au <a href="#1.5._Les_reponses">§&nbsp;1.5</a>,
les
réponses
ont
un
format
bien
déterminé
et
peuvent être
composées
d'une ou plusieurs lignes. C'est la fonction <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_get_reply()</b></font></font>
qui réalise cette opération&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">int
roof_get_reply(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; roof_ctx_t
&nbsp;*pContext, // Contexte externe<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; const
char **reply &nbsp; &nbsp; // Réponse<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; )<br>
{<br>
roof_context_t
*pCtx = ROOF_CTX(pContext);<br>
fd_set
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fdset;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
rc;<br>
struct
timeval &nbsp;to;<br>
unsigned
int &nbsp; &nbsp;i;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
first =
1;<br>
unsigned
int &nbsp; &nbsp;offset = 0;<br>
unsigned
int &nbsp; &nbsp;lreply;<br>
char
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;code[4];</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;&nbsp;*reply
= NULL;<br>
&nbsp; lreply
= pCtx-&gt;l_iobuf;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">one_more_time:</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
FD_ZERO(&amp;fdset);<br>
&nbsp; FD_SET(pCtx-&gt;ctrl,
&amp;fdset);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(pCtx-&gt;timeout_ms)<br>
&nbsp; {<br>
&nbsp; &nbsp; to.tv_sec
= pCtx-&gt;timeout_ms / 1000;<br>
&nbsp; &nbsp; to.tv_usec
= (pCtx-&gt;timeout_ms % 1000) * 1000;<br>
&nbsp; &nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">select</font></font>(pCtx-&gt;ctrl
+
1,
&amp;fdset,
NULL,
NULL,
&amp;to);<br>
&nbsp; }<br>
&nbsp; else<br>
&nbsp; {<br>
&nbsp; &nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">select</font></font>(pCtx-&gt;ctrl
+
1,
&amp;fdset,
NULL,
NULL,
NULL);<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
switch(rc)<br>
&nbsp; {<br>
&nbsp; &nbsp; case
-1: // Erreur ou signal<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; if
(EINTR == errno)<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; goto
one_more_time;<br>
&nbsp; &nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s' (%d) on select()\n", strerror(errno), errno);<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; case
0: // Timeout<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Timeout on read\n");<br>
&nbsp; &nbsp; &nbsp; errno
= ETIMEDOUT;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; case
1 : // Données en provenance de la connexion<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; char
*p;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_read_line(</font></font>pCtx,
pCtx-&gt;ctrl,
pCtx-&gt;iobuf
+
offset,
lreply);<br>
&nbsp; &nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; &nbsp; //
Si connexion fermée<br>
&nbsp; &nbsp; &nbsp; if
(0 == rc)<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; //
Ecrasement du buffer avec un code factice<br>
&nbsp; &nbsp; &nbsp; &nbsp; strcpy(pCtx-&gt;iobuf,
"600");<br>
&nbsp; &nbsp; &nbsp; &nbsp; lreply
= pCtx-&gt;l_iobuf - 3;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; //
Ajout d'informations additionnelles si assez de place<br>
&nbsp; &nbsp; &nbsp; &nbsp; strncat(pCtx-&gt;iobuf,
" End of connection", lreply);<br>
&nbsp; &nbsp; &nbsp; &nbsp;
pCtx-&gt;iobuf[pCtx-&gt;l_iobuf
- 1] = '\0';</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; *reply
= pCtx-&gt;iobuf;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return
0;<br>
&nbsp; &nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; [...]</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; //
Recherche de la fin de ligne<br>
&nbsp; &nbsp; &nbsp; p
= pCtx-&gt;iobuf + offset;<br>
&nbsp; &nbsp; &nbsp; i
= 0;<br>
&nbsp; &nbsp; &nbsp; while
(p &lt; (pCtx-&gt;iobuf + offset + rc))<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; if
(('\r' == *p) &amp;&amp; ('\n' == *(p + 1)))<br>
&nbsp; &nbsp; &nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
//
C'est
la
1ère
ligne</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if
(first)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
//
On
doit
avoir trois digits en début de ligne</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for
(i = 0; i &lt; 3; i ++)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; [...]<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; code[i]
= pCtx-&gt;iobuf[i];<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
// End for</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // <font color="#ff0000"><font style="font-size: 9pt;" size="2">Est-ce
une réponse multiligne ?</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if
('-' == pCtx-&gt;iobuf[i])<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; first
= 0;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Espace restant dans le buffer d'entrée<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; lreply
-= rc;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Nouveau début de buffer d'entrée dans le cas<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; //
d'une réponse multiligne<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; offset
+= rc;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; [...]<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; //
Lecture de la ligne suivante<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; goto
one_more_time;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // <font color="#ff0000"><font style="font-size: 9pt;" size="2">C'est
une réponse monoligne</font></font></font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Terminer la ligne en écrasant le dernier caractère
&lt;CR&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p
= '\0';<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
*reply
= pCtx-&gt;iobuf;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return
0;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else <font color="#ff0000"><font style="font-size: 9pt;" size="2">//
C'est une nouvelle ligne d'une réponse multiligne</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Conformément à la spécification, une ligne peut
commencer<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
avec un nombre. Donc, pour vérifier que c'est la dernière<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
ligne, on contrôle la valeur du code<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if
((rc &gt; 3) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; ('
' == ((pCtx-&gt;iobuf + offset)[3])) &nbsp; &amp;&amp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; (code[0]
== (pCtx-&gt;iobuf + offset)[0]) &amp;&amp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; (code[1]
== (pCtx-&gt;iobuf + offset)[1]) &amp;&amp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; (code[2]
== (pCtx-&gt;iobuf + offset)[2]))<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
//
Fin
de réponse multiligne</font></font></font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Terminer la ligne en écrasant le dernier caractère
&lt;CR&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; *p
= '\0';</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
*reply
= pCtx-&gt;iobuf;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
return
0;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else <font color="#ff0000"><font style="font-size: 9pt;" size="2">//
Ce n'est pas la fin d'une réponse multiligne</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; //
Espace restant dans le buffer d'entrée<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; lreply
-= rc;</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
Nouveau début de buffer pour une réponse multiligne<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; offset
+= rc;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; //
Lecture de la ligne suivante</font></font><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; goto
one_more_time;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; &nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; &nbsp; &nbsp; i
++;<br>
&nbsp; &nbsp; &nbsp; &nbsp; p
++;<br>
&nbsp; &nbsp; &nbsp; }
// End while<br>
&nbsp; &nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; default
: // Impossible ???!!!???<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; }
// End switch</font><br>
      <br>
      <font style="font-size: 9pt;" size="2">&nbsp;
return
-1;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">}
// roof_get_reply</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
fonction bien qu'un
peu longue est simple, elle se base sur l'appel système
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>select()</b></font></font>
pour attendre des données de la part du serveur sur le canal
de contrôle (socket <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctrl</b></font></font>
stockée dans le contexte interne). On notera l'utilisation du
timeout si celui-ci a été spécifié par
l'utilisateur lors de l'appel à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_new()</b></font></font>
décrit au <a href="#2.3._Le_contexte">§&nbsp;2.3</a>.
Cela évite d'attendre une
réponse qui ne viendrait pas si le serveur a un problème.
La fonction est capable de lire des réponses d'une ou
plusieurs lignes en testant la présence du tiret derrière
le code à 3 digits. Pour lire les lignes de données
envoyées par le serveur, la fonction s'appuie sur la routine
interne <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_read_line()</b></font></font>
qui lit des données jusqu'à l'apparition des
caractères
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LF</b></font></font>.
Il n'est pas très utile de la citer dans l'article.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_get_reply()</b></font></font>
fait partie de l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
car non seulement elle est utilisée en interne comme nous le
verrons mais peut aussi être utilisée en externe par
l'utilisateur désireux de réceptionner les messages
spontanés de la part du serveur. C'est donc pour cela qu'elle
reçoit en paramètre un contexte externe et non pas
interne.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2"><b>Nous
verrons dans les
fonctions suivantes que le traitement des réponses de la part
du serveur consiste à ne regarder que le premier digit du code
à 3 chiffres car il suffit à lui seul pour
déterminer
les actions à entreprendre par la suite (cela est
précisé
au §&nbsp;4.2 de la <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><a href="http://www.ietf.org/rfc/rfc959.txt">RFC959</a>)</font></font>.</b></font></font></p>
<h2 class="western"><a name="2.7._Connexion_au_serveur"></a>2.7.
Connexion au serveur</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">La
connexion au serveur
consiste tout d'abord à établir le canal de
contrôle
conformément à ce qui est indiqué au début
du §&nbsp;5.4 de la <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b><a href="http://www.ietf.org/rfc/rfc959.txt">RFC959</a>&nbsp;</b></font></font>:
le
canal
de
contrôle
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
est ouvert et le serveur envoie une réponse avec le code 220
pour indiquer qu'il est prêt. S'il n'est pas prêt à
recevoir des commandes, le serveur envoie une réponse 120 et
le client est sensé attendre jusqu'à réception
de la réponse 220.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">C'est
la mission de la
fonction de service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_open_ctrl()</b></font></font>
qui reçoit en paramètres l'adresse du serveur (qui peut
être un nom de machine ou une adresse <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>IP</b></font></font>)
et son numéro de port <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>.
Si le serveur est en attente sur le port standard (ce qui est
généralement le cas), l'utilisateur a la
possibilité
d'utiliser la constante <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF_DEF_PORT</b></font></font>
au lieu de la valeur en dur 21. Le code de retour de ce service est
la socket sur le canal de contrôle ou -1 en cas d'erreur. Le
champ <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ctrl</b></font></font>
du contexte interne mémorise l'identifiant de socket. On
remarquera l'utilisation de l'option de socket <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SO_LINGER</b></font></font>
pour faire en sorte que le protocole <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TCP</b></font></font>
donne toutes les chances à l'autre partie pour
récupérer
les données en attente avant fermeture définitive de la
connexion.</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">int
roof_open_ctrl(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; roof_ctx_t
&nbsp; *pContext, // Contexte externe<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; const
char &nbsp; *<font color="#ff0000"><font style="font-size: 9pt;" size="2">host</font></font>,
&nbsp; &nbsp; // Adresse du serveur (nom ou adresse IP)<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; unsigned
int &nbsp;<font color="#ff0000"><font style="font-size: 9pt;" size="2">port</font></font>
&nbsp; &nbsp; &nbsp;// Numéro de port du serveur<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; )<br>
{<br>
roof_context_t
&nbsp; &nbsp; *pCtx = ROOF_CTX(pContext);<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; rc;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; sd = -1;<br>
struct
sockaddr_in &nbsp;addr;<br>
struct
hostent &nbsp; &nbsp; *pHost;<br>
char &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;*code;<br>
struct
linger &nbsp; &nbsp; &nbsp; opt_linger;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; err_sav;<br>
&nbsp; [...]<br>
&nbsp; //
Obtention d'un descripteur de socket TCP<br>
&nbsp; sd
= socket(PF_INET, <font color="#ff0000"><font style="font-size: 9pt;" size="2">SOCK_STREAM</font></font>,
0);<br>
&nbsp; [...]<br>
&nbsp; //
Positionnement de l'option SO_LINGER pour faire en sorte que
l'appelant<br>
&nbsp; //
de close() sur la socket attende jusqu'à ce que l'autre partie
ait<br>
&nbsp; //
récupéré toutes les données en attente
sur la connexion<br>
&nbsp; opt_linger.l_onoff
= 1; // Activation de LINGER<br>
&nbsp; opt_linger.l_linger
= 2; // Duree d'attente en unites de 100ms<br>
&nbsp; rc
= setsockopt(sd, SOL_SOCKET, <font color="#ff0000"><font style="font-size: 9pt;" size="2">SO_LINGER</font></font>,
&amp;opt_linger,
sizeof(opt_linger));<br>
&nbsp; [...]<br>
&nbsp; //
Conversion du nom de host en adresse<br>
&nbsp; pHost
= gethostbyname(host);<br>
&nbsp; [...]<br>
&nbsp; //
Renseignement de l'adresse<br>
&nbsp; memset(&amp;addr,
0, sizeof(addr));<br>
&nbsp; addr.sin_family
= AF_INET;<br>
&nbsp; addr.sin_port
= htons(port);<br>
&nbsp; addr.sin_addr.s_addr
= (in_addr_t)(*(unsigned long *)(pHost-&gt;h_addr_list[0]));<br>
      </font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; // <font color="#ff0000"><font style="font-size: 9pt;" size="2">Connexion
au host distant</font></font><br>
&nbsp; rc
= connect(sd, (struct sockaddr *)&amp;addr, sizeof(addr));<br>
&nbsp; [...]<br>
&nbsp; //
On renseigne le contexte maintenant car roof_get_reply() a besoin que<br>
&nbsp; //
le champ ctrl soit renseigné<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
pCtx-&gt;ctrl
=
sd;</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
// <font color="#ff0000"><font style="font-size: 9pt;" size="2">On
boucle jusqu'à obtention de la réponse 2yz ou timeout</font></font><br>
&nbsp; do<br>
&nbsp; {<br>
&nbsp; &nbsp; //
Attente d'une réponse de la part du serveur<br>
&nbsp; &nbsp; rc
= roof_get_reply(pContext, &amp;code);<br>
&nbsp; &nbsp; [...]<br>
&nbsp; &nbsp; if
((code[0] != '1') &amp;&amp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; (code[0]
!= '2'))<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Negative reply code '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; rc
= -1;<br>
&nbsp; &nbsp; &nbsp; goto
error;<br>
&nbsp; &nbsp; }<br>
&nbsp; }
while (code[0] != '2');</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
rc
= sd;<br>
&nbsp; goto
end;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">error:</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
err_sav
= errno;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(sd &gt;= 0)<br>
&nbsp; {<br>
&nbsp; &nbsp; close(sd);<br>
&nbsp; &nbsp; sd
= -1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
pCtx-&gt;ctrl
= -1;<br>
&nbsp; errno
= err_sav;</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">end:</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
return
rc;<br>
}
// roof_open_ctrl</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
deuxième et
dernière phase de la connexion au serveur est la mise en
oeuvre de la procédure d'identification. La <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>
propose un diagramme qui est reproduit (avec quelques adaptations) en
<a href="#Figure_5">figure 5</a>. Le diagramme
montre que en fonction des serveurs,
l'identification se contentera de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
ou alors de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
suivie de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASS</b></font></font>
ou enfin de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
suivie de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASS</b></font></font>
suivie de la commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ACCT</b></font></font>.
Dans la pratique, le cas le plus courant est <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>USER</b></font></font>
suivi de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASS</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_5"></a>Figure
5&nbsp;:
Diagramme d'identification</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 681px; height: 587px;" alt="figure_5" src="ftp_api_fr_figure_5.jpg"></i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">C'est
la fonction de
service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_login()</b></font></font>
qui met en oeuvre l'automate d'identification. Nous citons cette
fonction afin de montrer que les commandes sont envoyées par
la routine interne <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_send_cmd()</b></font></font>
vue plus haut, les réponses sont réceptionnées
par le service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_get_reply()</b></font></font>
vu plus haut et les diagrammes de la recommandation sont
implémentés
sous forme d'une série de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>switch/case</b></font></font>
pour tester les valeurs des réponses et de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>goto</b></font></font>
pour changer d'état.</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">int
roof_login(<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;roof_ctx_t
*pContext, // Contexte externe<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;const
char *login, &nbsp; &nbsp;// Nom de login<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;const
char *passwd, &nbsp; // Mot de passe<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;const
char *account &nbsp; // Informations de compte<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; )<br>
{<br>
roof_context_t
*pCtx = ROOF_CTX(pContext);<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
rc;<br>
const
char &nbsp; &nbsp; *code;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
assert(NULL
!= pCtx);<br>
&nbsp; assert(pCtx-&gt;busy);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(!login || !(login[0]))<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"NULL login parameter\n");<br>
&nbsp; &nbsp; errno
= EINVAL;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_send_cmd</font></font>(pCtx,
"USER
%s\r\n",
login);<br>
&nbsp; [...]<br>
&nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_get_reply</font></font>(ROOF_EXT_CTX(pCtx),
&amp;code);<br>
&nbsp; [...]<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
switch</font></font>(code[0])<br>
&nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'1'</font></font> : // Reponse positive
preliminaire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'4'</font></font> : // Terminaison negative
transitoire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'5'</font></font> : // Terminaison negative
permanente<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; case
'3'</font></font> : // Reponse positive
intermediaire<br>
&nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
goto
send_passwd;</font></font><br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; case
'2'</font></font> : // Terminaison positive<br>
&nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
goto
end;</font></font><br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; default
: // Normalement impossible<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Unexpected reply code '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;<br>
&nbsp; }
// End switch</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">send_passwd:</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(!passwd || !(passwd[0]))<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Password parameter is required by server\n");<br>
&nbsp; &nbsp; errno
= EINVAL;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_send_cmd</font></font>(pCtx,
"PASS
%s\r\n",
passwd);<br>
&nbsp; [...]<br>
&nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_get_reply</font></font>(ROOF_EXT_CTX(pCtx),
&amp;code);<br>
&nbsp; [...]<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
switch</font></font>(code[0])<br>
&nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'1'</font></font> : // Reponse positive
preliminaire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'4'</font></font> : // Terminaison negative
transitoire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'5'</font></font> : // Terminaison negative
permanente<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; case
'3'</font></font> : // Reponse positive
intermediaire<br>
&nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
goto
send_account;</font></font><br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; case
'2'</font></font> : // Terminaison positive<br>
&nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
goto
end;</font></font><br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; default
: // Normalement impossible<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Unexpected reply code '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;<br>
&nbsp; }
// End switch</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">send_account:</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(!account || !(account[0]))<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Account parameter is required by server\n");<br>
&nbsp; &nbsp; errno
= EINVAL;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_send_cmd</font></font>(pCtx,
"ACCT
%s\r\n",
account);<br>
&nbsp; [...]<br>
&nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_get_reply</font></font>(ROOF_EXT_CTX(pCtx),
&amp;code);<br>
&nbsp; [...]<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
switch(</font></font>code[0])<br>
&nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'1'</font></font> : // Reponse preliminaire
positive<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'3'</font></font> : // Reponse positive
intermediaire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'4'</font></font> : // Terminaison negative
transitoire<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
case
'5'</font></font> : // Terminaison negative
permanente<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; &nbsp; case
'2'</font></font> : // Terminaison positive<br>
&nbsp; &nbsp; {<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
&nbsp;
&nbsp;
goto
end;</font></font><br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; default
: // Normalement impossible<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Unexpected reply code '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; break;<br>
&nbsp; }
// End switch</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">end:</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
return
0;<br>
}
// roof_login</font></p>
      </td>
    </tr>
  </tbody>
</table>
<h2 class="western"><a name="2.8._Diagramme_numero_1"></a>2.8.
Diagramme numéro 1</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
diagramme de la <a href="#Figure_6">figure
6</a> est le premier présenté au §&nbsp;6 de la
<a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>.
Il concerne les commandes <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ABOR</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ALLO</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>DELE</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CWD</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>CDUP</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SMNT</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>HELP</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>MODE</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NOOP</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>QUIT</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SITE</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PORT</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SYST</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STAT</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RMD</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>MKD</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PWD</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STRU</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>TYPE</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_6"></a>Figure
6&nbsp;:
Diagramme numéro 1</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 417px; height: 455px;" alt="figure_6" src="ftp_api_fr_figure_6.jpg"></i></font></font></p>
<h2 class="western"><a name="2.9._Diagramme_numero_2"></a>2.9.
Diagramme numéro 2</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
diagramme de la <a href="#Figure_7">figure
7</a> est le second présenté au §&nbsp;6 de la <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>.
Il concerne les commandes de transfert des données <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>APPE</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>LIST</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NLST</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>REIN</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RETR</b></font></font>,
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STOR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>STOU</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_7"></a>Figure
7&nbsp;:
Diagramme numéro 2</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 851px; height: 473px;" alt="figure_7" src="ftp_api_fr_figure_7.jpg"></i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Cette
automate introduit
la fonction <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_open_data()</b></font></font>
qui ouvre le canal de données afin de transférer le
contenu des fichiers ou répertoires&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver; font-family: monospace;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;"><font style="font-size: 9pt;" size="2">static
int roof_open_data(roof_context_t *pCtx) // Contexte interne<br>
{<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; rc;<br>
const
char &nbsp; &nbsp; &nbsp; &nbsp; *code;<br>
char &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; *p;<br>
int
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; port_lsb, port_msb, port;<br>
struct
sockaddr_in &nbsp;addr;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; data;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; err_sav;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_send_cmd</font></font>(pCtx,
"<font color="#ff0000"><font style="font-size: 9pt;" size="2">PASV</font></font>\r\n");<br>
&nbsp; [...]<br>
&nbsp; rc
= <font color="#ff0000"><font style="font-size: 9pt;" size="2">roof_get_reply</font></font>(ROOF_EXT_CTX(pCtx),
&amp;code);<br>
&nbsp; [...]<br>
&nbsp; //
S'assurer que la réponse est OK<br>
&nbsp; if
(<font color="#ff0000"><font style="font-size: 9pt;" size="2">code[0]
!= '2'</font></font>)<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Error '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; //
Parsing de la réponse du serveur pour obtenir le numéro
de port<br>
&nbsp; //
et l'adresse du serveur</font></font><br>
&nbsp; p
= pCtx-&gt;iobuf;<br>
&nbsp; while
(*p &amp;&amp; (*p != ')'))<br>
&nbsp; {<br>
&nbsp; &nbsp; p
++;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(*p != ')')<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Expected a terminating ')' in '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
*p
= '\0';</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
while
((p != pCtx-&gt;iobuf) &amp;&amp; (*p != ','))<br>
&nbsp; {<br>
&nbsp; &nbsp; p
--;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
((*p != ',') &amp;&amp; (!isdigit(*(p+1))))<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Expected a ',' followed by a digit in '%s'\n",
pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
*p
= '\0';</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
port_lsb
= atoi(p+1);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
while
((p != pCtx-&gt;iobuf) &amp;&amp; (*p != ','))<br>
&nbsp; {<br>
&nbsp; &nbsp; p
--;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
((*p != ',') &amp;&amp; (!isdigit(*(p+1))))<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Expected a ',' followed by a digit in '%s'\n",
pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
*p
= '\0';</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
port_msb
= atoi(p+1);<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
port
=
(port_msb
&lt;&lt;
8)
|
port_lsb;</font></font></font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; //
Conversion de l'adresse en format «&nbsp;point&nbsp;»</font></font><br>
&nbsp; p--;<br>
&nbsp; while
((p != pCtx-&gt;iobuf) &amp;&amp; (*p != '('))<br>
&nbsp; {<br>
&nbsp; &nbsp; if
(',' == *p)<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; *p
= '.';<br>
&nbsp; &nbsp; }<br>
&nbsp; &nbsp; else<br>
&nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; if
(!isdigit(*p))<br>
&nbsp; &nbsp; &nbsp; {<br>
&nbsp; &nbsp; &nbsp; &nbsp; ROOF_ERR(pCtx,
"Expected a digit in the server's address'%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; &nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return
-1;<br>
&nbsp; &nbsp; &nbsp; }<br>
&nbsp; &nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
&nbsp; p
--;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
if
(*p != '(')<br>
&nbsp; {<br>
&nbsp; &nbsp; ROOF_ERR(pCtx,
"Expected a '(' in '%s'\n", pCtx-&gt;iobuf);<br>
&nbsp; &nbsp; errno
= EIO;<br>
&nbsp; &nbsp; return
-1;<br>
&nbsp; }</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Renseignement de l'adresse du serveur<br>
&nbsp; memset(&amp;addr,
0, sizeof(addr));<br>
&nbsp; addr.sin_family
= AF_INET;<br>
&nbsp; addr.sin_port
= htons(port);<br>
&nbsp; addr.sin_addr.s_addr
= inet_addr(p+1);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2"><font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp; //
Création de la socket pour le canal de données</font></font><br>
&nbsp; data
= socket(PF_INET, SOCK_STREAM, 0);<br>
&nbsp; [...]<br>
      <font color="#ff0000"><font style="font-size: 9pt;" size="2">&nbsp;
//
Connexion
au
serveur</font></font><br>
&nbsp; rc
= connect(data, (struct sockaddr *)&amp;addr, sizeof(addr));<br>
&nbsp; [...]<br>
&nbsp; return
data;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto;">
      <font style="font-size: 9pt;" size="2">}
// roof_open_data</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">La
commande <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>PASV</b></font></font>
est envoyée au serveur pour le faire passer en mode passif. Le
serveur répond par un code «&nbsp;2&nbsp;» du
style «&nbsp;<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>227
Entering Passive Mode (127,0,0,1,128,87)&nbsp;» </b></font></font>pour
donner
le
numéro
de
port
sur
lequel
il va attendre une
connexion du client. Les nombres entre parenthèses
séparés
par des virgules sont normalisés dans la <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>.
Ils représentent de gauche à droite l'adresse <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>IP</b></font></font>
(les quatre premiers champs, soient 127.0.0.1), le poids fort et le
poids faible du numéro de port codé sur 16 bits (soit
128 * 256 + 87 = 32855). Une fois ces informations obtenues, une
socket est créée pour établir le canal de
données avec le serveur. L'identifiant de la socket est le
code de retour de la fonction si tout s'est bien passé (sinon
l'erreur -1 est retournée).</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Nous
ne décrirons
pas ici les fonctions qui implémentent les commandes se basant
sur le diagramme numéro 2 car elles utilisent le même
principe que <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_login()</b></font></font>
vue plus haut.</font></font></p>
<h2 class="western"><a name="2.10._Diagramme_numero_3"></a>2.10.
Diagramme numéro 3</h2>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Le
diagramme de la <a href="#Figure_8">figure
8</a> est le troisième présenté au §&nbsp;6
de
la <a href="http://www.ietf.org/rfc/rfc959.txt"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RFC959</b></font></font></a>.
Il concerne les commandes de renommage de fichier <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNFR</b></font></font>
et <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>RNTO</b></font></font>.
Cette automate est implémenté dans la fonction de
service <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>roof_mv()</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;">
<font face="Arial Narrow, sans-serif"><font size="2"><i><a name="Figure_8"></a>Figure
8&nbsp;:
Diagramme numéro 3</i></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto; text-align: center;"><font face="Arial Narrow, sans-serif"><font size="2"><i><img style="width: 681px; height: 303px;" alt="figure_8" src="ftp_api_fr_figure_8.jpg"></i></font></font></p>
<h1 class="western"><a name="3._Exemple_dutilisation_de_lAPI"></a>3.
Exemple
d'utilisation de l'API</h1>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Pour
un exemple complet,
le lecteur pourra se référer au code source de <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF&nbsp;</b></font></font>:
le sous-répertoire <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>client</b></font></font>
contient un exemple de client <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
en mode ligne de commande se basant sur l'<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Ici
est présenté
un tout petit programme d'exemple appelé <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>test_ftp</b></font></font>
qui effectue une connexion vers un serveur, affiche le type du
système hôte, affiche le nom du répertoire de
travail et liste le contenu de ce dernier&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">#include
&lt;stdio.h&gt;<br>
#include
&lt;libgen.h&gt;<br>
#include
&lt;assert.h&gt;<br>
#include
&lt;unistd.h&gt;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">//
Installe par defaut dans '/usr/local/include'<br>
#include
&lt;roof.h&gt;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">//
Callback pour afficher le contenu d'un repertoire<br>
//<br>
//
Parametres: ctx = parametre 'ctx' passe a roof_list()<br>
// buf =
Donnees du directory<br>
// lbuf =
taille des donnees dans 'buf'<br>
static
int affiche(roof_ctx_t *ctx, const char *buf, unsigned int lbuf)<br>
{<br>
int
rc;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
(void)ctx;
// Parametre non utilise (suppression warning compilo)</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
rc
= write(1, buf, lbuf);<br>
&nbsp; assert(lbuf
== (unsigned)rc);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Retour OK a la librairie<br>
&nbsp; return
lbuf;<br>
}
// affiche</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <br>
      </p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">//
Point d'entree du programme<br>
//<br>
//
Parametres: av[1] = hote_destination<br>
// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
av[2] =
nom_de_login<br>
// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
av[3] =
mot_de_passe<br>
int
main(int ac, char *av[])<br>
{<br>
roof_ctx_t
*pCtx; // Objet ROOF<br>
int &nbsp; &nbsp; &nbsp; &nbsp; ctrl;
// Socket sur le canal de contrôle<br>
char &nbsp; &nbsp; &nbsp; *p;<br>
int &nbsp; &nbsp; &nbsp; &nbsp; rc;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Validation des parametres du programme<br>
&nbsp; if
(ac != 4)<br>
&nbsp; {<br>
&nbsp; &nbsp; fprintf(stderr,
"Usage: %s host login passwd\n", basename(av[0]));<br>
&nbsp; &nbsp; return
1;<br>
&nbsp; }</font><br>
      <br>
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Creation de l'objet ROOF avec:<br>
&nbsp; // .
Timeout 10 secondes<br>
&nbsp; // .
Allocation du buffer d'E/S par la librairie<br>
&nbsp; // . Pas de
contexe utilisateur<br>
&nbsp; pCtx
= roof_new(10000, NULL, 0, NULL);<br>
&nbsp; assert(pCtx);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Ouverture du canal de controle<br>
&nbsp; ctrl
= roof_open_ctrl(pCtx, av[1], ROOF_DEF_PORT);<br>
&nbsp; assert(ctrl
&gt;= 0);</font><br>
      <br>
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Authentification sur le hote distant<br>
&nbsp; rc
= roof_login(pCtx, av[2], av[3], NULL);<br>
&nbsp; assert(0
== rc);</font></p>
      <span style="font-family: monospace;"></span>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">&nbsp; //
Affichage du type du systeme hote<br>
&nbsp; rc
= roof_syst(pCtx, &amp;p);<br>
&nbsp; assert(0
== rc);<br>
&nbsp; printf("Le
type du systeme hote est : %s\n", p);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Affichage du chemin du repertoire courant<br>
&nbsp; rc
= roof_pwd(pCtx, &amp;p);<br>
&nbsp; assert(0
== rc);<br>
&nbsp; printf("Le
repertoire courant est : %s\n", p);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Affichage du contenu du repertoire courant<br>
&nbsp; printf("Le
contenu du repertoire courant est :\n");<br>
&nbsp; rc
= roof_list(pCtx, NULL, affiche);<br>
&nbsp; assert(0
== rc);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Fermeture du canal de controle<br>
&nbsp; rc
= roof_close_ctrl(pCtx);<br>
&nbsp; assert(0
== rc);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
//
Desallocation de l'objet ROOF<br>
&nbsp; roof_delete(pCtx);</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">&nbsp;
return
0;</font></p>
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;">
      <font style="font-size: 9pt;" size="2">}
// main</font></p>
      </td>
    </tr>
  </tbody>
</table>
<span style="font-family: Arial,sans-serif;"><br>
</span>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"><font face="Arial, sans-serif"><font size="2">Le
programme peut être
généré comme suit si la librairie <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>libroof.so</b></font></font>
a été installée&nbsp;:</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$
gcc test_ftp.c -o test_ftp -lroof</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify"><font face="Arial, sans-serif"><font size="2">Voici,
pour finir, un
exemple d'exécution du programme de test avec connexion au
serveur de la machine locale (localhost), avec le nom de login
«&nbsp;foo&nbsp;» et le mot de passe
«&nbsp;bar&nbsp;» :</font></font></p>
<table style="text-align: left; background-color: silver;" border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="white-space: nowrap;">
      <p style="background: transparent none repeat scroll 0% 50%; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; margin-bottom: 0cm; page-break-before: auto; font-family: monospace;"><font style="font-size: 9pt;" size="2">$
./test_ftp localhost foo bar<br>
Le
type du systeme hote est : 215 UNIX Type: L8 (Linux)<br>
Le
repertoire courant est : 257 "/home/foo" is current
directory.<br>
Le
contenu du repertoire courant est :<br>
total
2256<br>
-rw-r--r--
1 foo foo 60 Jan 16 08:55 fichier1<br>
-rw-------
1 foo foo 203 Jan 16 08:55 fichier2<br>
drwx------
2 foo foo 4096 Mar 11 2007 repertoire<br>
$</font></p>
      </td>
    </tr>
  </tbody>
</table>
<h1 class="western"><a name="4._Conclusion"></a>4.
Conclusion</h1>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Après
une étude
rapide de la recommandation <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>,
il a été possible de développer une <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>API</b></font></font>
appelé <a href="http://roof.sourceforge.net/"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>ROOF</b></font></font></a>&nbsp;très
simple
à
mettre
en
oeuvre
et
adaptable
à
toute application nécessitant le transfert de fichiers par un
protocole standard. Comme exemples d'applications dans lesquelles le
lecteur pourrait se lancer, on peut citer un client <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
en mode graphique ou un système de fichiers distant basé
sur <a href="http://fuse.sourceforge.net/"><font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FUSE</b></font></font></a>
comme alternative à <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>NFS</b></font></font>.</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;" align="justify">
<font face="Arial, sans-serif"><font size="2">Pour
approfondir le
sujet, le lecteur pourra aussi s'intéresser aux
évolutions
du protocole car <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
a fait l'objet de diverses améliorations depuis sa
création
et notamment, sur le plan de la fiabilité et de la
sécurité
pour donner&nbsp;: <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SFTP</b></font></font>
(«&nbsp;<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
over <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SSH</b></font></font>&nbsp;»
à ne pas confondre avec «&nbsp;Simple <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>&nbsp;»)
ou
<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTPS</b></font></font>
(«&nbsp;<font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
over <font face="Bitstream Vera Sans Mono, monospace"><font style="font-size: 9pt;" size="2"><b>SSL</b></font></font>&nbsp;»).</font></font></p>
<h1 class="western"><a name="Liens"></a>Liens</h1>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[1]
Recommandation FTP :
<a href="http://www.ietf.org/rfc/rfc959.txt">http://www.ietf.org/rfc/rfc959.txt</a></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[2]
Recommandation TELNET
: <a href="http://www.ietf.org/rfc/rfc854.txt">http://www.ietf.org/rfc/rfc854.txt</a></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[3]
Remote Operations On
Files : <a href="http://roof.sourceforge.net/">http://roof.sourceforge.net/</a></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[4]
Aperçu de
cmake : <a href="http://rachid.koucha.free.fr/tech_corner/cmake_manual.html">http://rachid.koucha.free.fr/tech_corner/cmake_manual.html</a></font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[5]
Constructeurs/destructeurs dans les librairies partagées :
<a href="http://tldp.org/HOWTO/Program-Library-HOWTO/miscellaneous.html#INIT-AND-CLEANUP">http://tldp.org/HOWTO/Program-Library-HOWTO/miscellaneous.html#INIT-AND-CLEANUP</a></font></font></p>
<h1 class="western"><a name="References"></a>Références</h1>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[6]
Courbot (Alexandre),
«&nbsp;Cmake : la relève dans la construction de
projets&nbsp;», GLMF 92, Mars 2007</font></font></p>
<p style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[7]
Tricon (Lionel),
«&nbsp;FUSE, développez vos systèmes de fichiers
dans l'espace utilisateur&nbsp;», GLMF 92, Mars 2007</font></font></p>
<h1 class="western"><a name="A_propos_de_lauteur"></a>A
propos de l'auteur</h1>
<font face="Arial, sans-serif"><font size="2">L'auteur
est un ingénieur en informatique travaillant en France. Il peut
être
contacté <a href="http://rachid.koucha.free.fr/contact/contact.html">ici</a>
ou vous pouvez
consulter son site <a href="http://rachid.koucha.free.fr/">WEB</a>.<br>
<br>
<table style="background-color: silver; text-align: left; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
</font></font>
<p style="margin-bottom: 0cm; text-align: right;"><small><a href="../index.html">Page principale</a><br>
<a href="../documents_techniques.html">Page précédente</a></small><br>
</p>
<p style="margin-bottom: 0cm;"><br>
</p>

</body></html>e
repertoire courant est : 257 "/home/foo" is current
directory.<br>
Le
contenu du repertoire courant est :<br>
total
2256<br>
-rw-r--r--
1 foo foo 60 Jan 16 08:55 fichier1<br>
-rw-------
1 foo foo 203 Jan 16 08:55 fichier2<br>
drwx------
2 foo foo 4096 Mar 11 2007 repertoire<br>
$</font></p>
      </td>
    </tr>
  </tbody>
</table>
<h1 class="western"><a name="4._Conclusion"></a>4.
Conclusion</h1>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"
 align="justify">
<font face="Arial, sans-serif"><font size="2">Apr&egrave;s
une &eacute;tude
rapide de la recommandation <font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>,
il a &eacute;t&eacute; possible de d&eacute;velopper une <font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>API</b></font></font>
appel&eacute; <a href="http://roof.sourceforge.net/"><font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>ROOF</b></font></font></a>&nbsp;tr&egrave;s
simple
&agrave;
mettre
en
oeuvre
et
adaptable
&agrave;
toute application n&eacute;cessitant le transfert de fichiers par un
protocole standard. Comme exemples d'applications dans lesquelles le
lecteur pourrait se lancer, on peut citer un client <font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
en mode graphique ou un syst&egrave;me de fichiers distant bas&eacute;
sur <a href="http://fuse.sourceforge.net/"><font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FUSE</b></font></font></a>
comme alternative &agrave; <font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>NFS</b></font></font>.</font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;"
 align="justify">
<font face="Arial, sans-serif"><font size="2">Pour
approfondir le
sujet, le lecteur pourra aussi s'int&eacute;resser aux
&eacute;volutions
du protocole car <font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
a fait l'objet de diverses am&eacute;liorations depuis sa
cr&eacute;ation
et notamment, sur le plan de la fiabilit&eacute; et de la
s&eacute;curit&eacute;
pour donner&nbsp;: <font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>SFTP</b></font></font>
(&laquo;&nbsp;<font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
over <font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>SSH</b></font></font>&nbsp;&raquo;
&agrave; ne pas confondre avec &laquo;&nbsp;Simple <font
 face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>&nbsp;&raquo;)
ou
<font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTPS</b></font></font>
(&laquo;&nbsp;<font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>FTP</b></font></font>
over <font face="Bitstream Vera Sans Mono, monospace"><font
 style="font-size: 9pt;" size="2"><b>SSL</b></font></font>&nbsp;&raquo;).</font></font></p>
<h1 class="western"><a name="Liens"></a>Liens</h1>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[1]
Recommandation FTP :
<a href="http://www.ietf.org/rfc/rfc959.txt">http://www.ietf.org/rfc/rfc959.txt</a></font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[2]
Recommandation TELNET
: <a href="http://www.ietf.org/rfc/rfc854.txt">http://www.ietf.org/rfc/rfc854.txt</a></font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[3]
Remote Operations On
Files : <a href="http://roof.sourceforge.net/">http://roof.sourceforge.net/</a></font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[4]
Aper&ccedil;u de
cmake : <a
 href="http://rachid.koucha.free.fr/tech_corner/cmake_manual.html">http://rachid.koucha.free.fr/tech_corner/cmake_manual.html</a></font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[5]
Constructeurs/destructeurs dans les librairies partag&eacute;es :
<a
 href="http://tldp.org/HOWTO/Program-Library-HOWTO/miscellaneous.html#INIT-AND-CLEANUP">http://tldp.org/HOWTO/Program-Library-HOWTO/miscellaneous.html#INIT-AND-CLEANUP</a></font></font></p>
<h1 class="western"><a name="References"></a>R&eacute;f&eacute;rences</h1>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[6]
Courbot (Alexandre),
&laquo;&nbsp;Cmake : la rel&egrave;ve dans la construction de
projets&nbsp;&raquo;, GLMF 92, Mars 2007</font></font></p>
<p
 style="margin-top: 0.2cm; margin-bottom: 0.1cm; page-break-before: auto;">
<font face="Arial, sans-serif"><font size="2">[7]
Tricon (Lionel),
&laquo;&nbsp;FUSE, d&eacute;veloppez vos syst&egrave;mes de fichiers
dans l'espace utilisateur&nbsp;&raquo;, GLMF 92, Mars 2007</font></font></p>
<h1 class="western"><a name="A_propos_de_lauteur"></a>A
propos de l'auteur</h1>
<font face="Arial, sans-serif"><font size="2">L'auteur
est un ing&eacute;nieur en informatique travaillant en France. Il peut
&ecirc;tre
contact&eacute; <a
 href="http://rachid.koucha.free.fr/contact/contact.html">ici</a>
ou vous pouvez
consulter son site <a href="http://rachid.koucha.free.fr/">WEB</a>.<br>
<br>
<table
 style="background-color: silver; text-align: left; margin-left: auto; margin-right: auto;">
  <tbody>
    <tr>
      <td>
      <script type="text/javascript"><!--
google_ad_client = "pub-9113501896220746";
/* 728x90, date de création 29/03/08 */
google_ad_slot = "7632855209";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
      <script type="text/javascript"
 src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><br>
      </td>
    </tr>
  </tbody>
</table>
</font></font>
<p style="margin-bottom: 0cm; text-align: right;"><small><a
 href="../index.html">Page principale</a><br>
<a href="../documents_techniques.html">Page pr&eacute;c&eacute;dente</a></small><br>
</p>
<p style="margin-bottom: 0cm;"><br>
</p>
</body>
</html>
