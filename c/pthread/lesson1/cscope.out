cscope 15 /data/root/program/c/pthread/lesson1 -q 0000000290 0000015572
	@control.c

27 
	~"cÚŒŞ.h
"

29 
	$cÚŒŞ_š™
(
d©a_cÚŒŞ
 *
mycÚŒŞ
) {

30 
my¡©us
;

31 ià(
	`±h»ad_mu‹x_š™
(&(
mycÚŒŞ
->
mu‹x
),
NULL
))

33 ià(
	`±h»ad_cÚd_š™
(&(
mycÚŒŞ
->
cÚd
),
NULL
))

35 
mycÚŒŞ
->
aùive
=0;

37 
	}
}

39 
	$cÚŒŞ_de¡roy
(
d©a_cÚŒŞ
 *
mycÚŒŞ
) {

40 
my¡©us
;

41 ià(
	`±h»ad_cÚd_de¡roy
(&(
mycÚŒŞ
->
cÚd
)))

43 ià(
	`±h»ad_cÚd_de¡roy
(&(
mycÚŒŞ
->
cÚd
)))

45 
mycÚŒŞ
->
aùive
=0;

47 
	}
}

48 
	$cÚŒŞ_aùiv©e
(
d©a_cÚŒŞ
 *
mycÚŒŞ
) {

49 
my¡©us
;

50 ià(
	`±h»ad_mu‹x_lock
(&(
mycÚŒŞ
->
mu‹x
)))

52 
mycÚŒŞ
->
aùive
=1;

53 
	`±h»ad_mu‹x_uÆock
(&(
mycÚŒŞ
->
mu‹x
));

54 
	`±h»ad_cÚd_brßdÿ¡
(&(
mycÚŒŞ
->
cÚd
));

56 
	}
}

58 
	$cÚŒŞ_d—ùiv©e
(
d©a_cÚŒŞ
 *
mycÚŒŞ
) {

59 
my¡©us
;

60 ià(
	`±h»ad_mu‹x_lock
(&(
mycÚŒŞ
->
mu‹x
)))

62 
mycÚŒŞ
->
aùive
=0;

63 
	`±h»ad_mu‹x_uÆock
(&(
mycÚŒŞ
->
mu‹x
));

64 
	`±h»ad_cÚd_brßdÿ¡
(&(
mycÚŒŞ
->
cÚd
));

66 
	}
}

	@control.h

1 
	~<±h»ad.h
>

2 
	sd©a_cÚŒŞ
 {

3 
±h»ad_mu‹x_t
 
	mmu‹x
;

4 
±h»ad_cÚd_t
 
	mcÚd
;

5 
	maùive
;

6 } 
	td©a_cÚŒŞ
;

	@csapp.h

2 #iâdeà
__CSAPP_H__


3 
	#__CSAPP_H__


	)

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<uni¡d.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

10 
	~<£tjmp.h
>

11 
	~<sigÇl.h
>

12 
	~<sys/time.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/wa™.h
>

15 
	~<sys/¡©.h
>

16 
	~<fú.h
>

17 
	~<sys/mmª.h
>

18 
	~<”ºo.h
>

19 
	~<m©h.h
>

20 
	~<±h»ad.h
>

21 
	~<£m­hÜe.h
>

22 
	~<sys/sock‘.h
>

23 
	~<Ãtdb.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<¬·/š‘.h
>

30 
	#DEF_MODE
 
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH


	)

31 
	#DEF_UMASK
 
S_IWGRP
|
S_IWOTH


	)

36 
sockaddr
 
	tSA
;

41 
	#RIO_BUFSIZE
 8192

	)

43 
	mrio_fd
;

44 
	mrio_út
;

45 *
	mrio_buåŒ
;

46 
	mrio_buf
[
RIO_BUFSIZE
];

47 } 
	trio_t
;

51 
h_”ºo
;

52 **
’vœÚ
;

55 
	#MAXLINE
 8192

	)

56 
	#MAXBUF
 8192

	)

57 
	#LISTENQ
 1024

	)

60 
unix_”rÜ
(*
msg
);

61 
posix_”rÜ
(
code
, *
msg
);

62 
dns_”rÜ
(*
msg
);

63 
­p_”rÜ
(*
msg
);

66 
pid_t
 
FÜk
();

67 
Execve
(cÚ¡ *
f’ame
, *cÚ¡ 
¬gv
[], *cÚ¡ 
’vp
[]);

68 
pid_t
 
Wa™
(*
¡©us
);

69 
pid_t
 
Wa™pid
Õid_ˆ
pid
, *
Œ
, 
İtiÚs
);

70 
Kl
(
pid_t
 
pid
, 
signum
);

71 
SË•
(
£cs
);

72 
Pau£
();

73 
AÏrm
(
£cÚds
);

74 
S‘pgid
(
pid_t
 
pid
,…id_ˆ
pgid
);

75 
pid_t
 
G‘pg½
();

78 
	thªdËr_t
();

79 
hªdËr_t
 *
SigÇl
(
signum
, hªdËr_ˆ*
hªdËr
);

80 
Sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
);

81 
Sigem±y£t
(
sig£t_t
 *
£t
);

82 
Sigfl£t
(
sig£t_t
 *
£t
);

83 
Sigadd£t
(
sig£t_t
 *
£t
, 
signum
);

84 
Sigd–£t
(
sig£t_t
 *
£t
, 
signum
);

85 
Sigismemb”
(cÚ¡ 
sig£t_t
 *
£t
, 
signum
);

88 
O³n
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
);

89 
ssize_t
 
R—d
(
fd
, *
buf
, 
size_t
 
couÁ
);

90 
ssize_t
 
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

91 
off_t
 
L£ek
(
fdes
, off_ˆ
off£t
, 
wh’û
);

92 
Clo£
(
fd
);

93 
S–eù
(
n
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
, fd_£ˆ*
exû±fds
,

94 
timev®
 *
timeout
);

95 
Dup2
(
fd1
, 
fd2
);

96 
St
(cÚ¡ *
f’ame
, 
¡©
 *
buf
);

97 
F¡©
(
fd
, 
¡©
 *
buf
) ;

100 *
Mm­
(*
addr
, 
size_t
 
Ën
, 
´Ù
, 
æags
, 
fd
, 
off_t
 
off£t
);

101 
Munm­
(*
¡¬t
, 
size_t
 
Ëngth
);

104 
Fşo£
(
FILE
 *
å
);

105 
FILE
 *
Fdİ’
(
fd
, cÚ¡ *
ty³
);

106 *
Fg‘s
(*
±r
, 
n
, 
FILE
 *
¡»am
);

107 
FILE
 *
Fİ’
(cÚ¡ *
f’ame
, cÚ¡ *
mode
);

108 
Fputs
(cÚ¡ *
±r
, 
FILE
 *
¡»am
);

109 
size_t
 
F»ad
(*
±r
, size_ˆ
size
, size_ˆ
nmemb
, 
FILE
 *
¡»am
);

110 
Fwr™e
(cÚ¡ *
±r
, 
size_t
 
size
, size_ˆ
nmemb
, 
FILE
 *
¡»am
);

113 *
M®loc
(
size_t
 
size
);

114 *
R—Îoc
(*
±r
, 
size_t
 
size
);

115 *
C®loc
(
size_t
 
nmemb
, size_ˆ
size
);

116 
F»e
(*
±r
);

119 
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

120 
S‘sockİt
(
s
, 
Ëv–
, 
İŠame
, cÚ¡ *
İtv®
, 
İ’
);

121 
Bšd
(
sockfd
, 
sockaddr
 *
my_addr
, 
add¾’
);

122 
Li¡’
(
s
, 
backlog
);

123 
Acû±
(
s
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

124 
CÚÃù
(
sockfd
, 
sockaddr
 *
£rv_addr
, 
add¾’
);

127 
ho¡’t
 *
G‘ho¡byÇme
(cÚ¡ *
Çme
);

128 
ho¡’t
 *
G‘ho¡byaddr
(cÚ¡ *
addr
, 
Ën
, 
ty³
);

131 
Pth»ad_ü—‹
(
±h»ad_t
 *
tidp
, 
±h»ad_©Œ_t
 *
©Œp
,

132 * (*
routše
)(*), *
¬gp
);

133 
Pth»ad_još
(
±h»ad_t
 
tid
, **
th»ad_»tuº
);

134 
Pth»ad_ÿnûl
(
±h»ad_t
 
tid
);

135 
Pth»ad_d‘ach
(
±h»ad_t
 
tid
);

136 
Pth»ad_ex™
(*
»tv®
);

137 
±h»ad_t
 
Pth»ad_£lf
();

138 
Pth»ad_Úû
(
±h»ad_Úû_t
 *
Úû_cÚŒŞ
, (*
š™_funùiÚ
)());

141 
Sem_š™
(
£m_t
 *
£m
, 
psh¬ed
, 
v®ue
);

142 
P
(
£m_t
 *
£m
);

143 
V
(
£m_t
 *
£m
);

146 
ssize_t
 
rio_»adn
(
fd
, *
u¤buf
, 
size_t
 
n
);

147 
ssize_t
 
rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
);

148 
rio_»adš™b
(
rio_t
 *
½
, 
fd
);

149 
ssize_t
 
rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
);

150 
ssize_t
 
rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
);

153 
ssize_t
 
Rio_»adn
(
fd
, *
u¤buf
, 
size_t
 
n
);

154 
Rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
);

155 
Rio_»adš™b
(
rio_t
 *
½
, 
fd
);

156 
ssize_t
 
Rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
);

157 
ssize_t
 
Rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
);

160 
İ’_ş›Áfd
(*
ho¡Çme
, 
pÜŠo
);

161 
İ’_li¡’fd
(
pÜŠo
);

164 
O³n_ş›Áfd
(*
ho¡Çme
, 
pÜt
);

165 
O³n_li¡’fd
(
pÜt
);

	@dbug.h

1 
	#dabÜt
() \

2 { 
	`´štf
("AbÜtšg‡ˆlš%d iÀsourû f%s\n",
__LINE__
,
__FILE__
); 
	`abÜt
(); }

	)

	@queue.c

23 
	~<¡dio.h
>

24 
	~"queue.h
"

25 
	$queue_š™
(
queue
 *
myroÙ
) {

26 
myroÙ
->
h—d
=
NULL
;

27 
myroÙ
->

=
NULL
;

28 
	}
}

29 
	$queue_put
(
queue
 *
myroÙ
,
node
 *
mynode
) {

30 
mynode
->
Ãxt
=
NULL
;

31 ià(
myroÙ
->

!=
NULL
)

32 
myroÙ
->

->
Ãxt
=
mynode
;

33 
myroÙ
->

=
mynode
;

34 ià(
myroÙ
->
h—d
==
NULL
)

35 
myroÙ
->
h—d
=
mynode
;

36 
	}
}

37 
node
 *
	$queue_g‘
(
queue
 *
myroÙ
) {

39 
node
 *
mynode
;

40 
mynode
=
myroÙ
->
h—d
;

41 ià(
myroÙ
->
h—d
!=
NULL
)

42 
myroÙ
->
h—d
=myroÙ->h—d->
Ãxt
;

43  
mynode
;

44 
	}
}

	@queue.h

6 
	snode
 {

7 
node
 *
	mÃxt
;

8 } 
	tnode
;

9 
	squeue
 {

10 
node
 *
	mh—d
, *
	m
;

11 } 
	tqueue
;

12 
queue_š™
(
queue
 *
myroÙ
);

13 
queue_put
(
queue
 *
myroÙ
, 
node
 *
mynode
);

14 
node
 *
queue_g‘
(
queue
 *
myroÙ
);

	@thread1.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<¡dio.h
>

6 *
	$th»ad_funùiÚ
(*
¬g
) {

7 
i
;

8  
i
=0; i<20; i++) {

9 
	`´štf
("Thread says hi!\n");

10 
	`¦“p
(1);

12  
NULL
;

13 
	}
}

14 
	$maš
() {

15 
±h»ad_t
 
myth»ad
;

17 iàĞ
	`±h»ad_ü—‹
Ğ&
myth»ad
, 
NULL
, 
th»ad_funùiÚ
, NULL) ) {

18 
	`´štf
("error creatinghread.");

19 
	`abÜt
();

21 iàĞ
	`±h»ad_još
 ( 
myth»ad
, 
NULL
 ) ) {

22 
	`´štf
("error joininghread.");

23 
	`abÜt
();

25 
	`ex™
(0);

26 
	}
}

	@thread2.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<¡dio.h
>

5 
	gmyglob®
;

6 *
	$th»ad_funùiÚ
(*
¬g
) {

7 
i
,
j
;

8  
i
=0; i<20; i++) {

9 
j
=
myglob®
;

10 
j
=j+1;

11 
	`´štf
(".");

12 
	`fæush
(
¡dout
);

13 
	`¦“p
(1);

14 
myglob®
=
j
;

16  
NULL
;

17 
	}
}

18 
	$maš
() {

19 
±h»ad_t
 
myth»ad
;

20 
i
;

21 iàĞ
	`±h»ad_ü—‹
Ğ&
myth»ad
, 
NULL
, 
th»ad_funùiÚ
, NULL) ) {

22 
	`´štf
("error creatinghread.");

23 
	`abÜt
();

25  
i
=0; i<20; i++) {

26 
myglob®
=myglobal+1;

27 
	`´štf
("o");

28 
	`fæush
(
¡dout
);

29 
	`¦“p
(1);

31 iàĞ
	`±h»ad_još
 ( 
myth»ad
, 
NULL
 ) ) {

32 
	`´štf
("error joininghread.");

33 
	`abÜt
();

35 
	`´štf
("\nmyglob®ƒqu® %d\n",
myglob®
);

36 
	`ex™
(0);

37 
	}
}

	@thread3.c

1 
	~<±h»ad.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<¡dio.h
>

5 
	gmyglob®
;

6 
±h»ad_mu‹x_t
 
	gmymu‹x
=
PTHREAD_MUTEX_INITIALIZER
;

7 *
	$th»ad_funùiÚ
(*
¬g
) {

8 
i
,
j
;

9  
i
=0; i<20; i++) {

10 
	`±h»ad_mu‹x_lock
(&
mymu‹x
);

11 
j
=
myglob®
;

12 
j
=j+1;

13 
	`´štf
(".");

14 
	`fæush
(
¡dout
);

15 
	`¦“p
(1);

16 
myglob®
=
j
;

17 
	`±h»ad_mu‹x_uÆock
(&
mymu‹x
);

19  
NULL
;

20 
	}
}

21 
	$maš
() {

22 
±h»ad_t
 
myth»ad
;

23 
i
;

24 iàĞ
	`±h»ad_ü—‹
Ğ&
myth»ad
, 
NULL
, 
th»ad_funùiÚ
, NULL) ) {

25 
	`´štf
("error creatinghread.");

26 
	`abÜt
();

28  
i
=0; i<20; i++) {

29 
	`±h»ad_mu‹x_lock
(&
mymu‹x
);

30 
myglob®
=myglobal+1;

31 
	`±h»ad_mu‹x_uÆock
(&
mymu‹x
);

32 
	`´štf
("o");

33 
	`fæush
(
¡dout
);

34 
	`¦“p
(1);

36 iàĞ
	`±h»ad_još
 ( 
myth»ad
, 
NULL
 ) ) {

37 
	`´štf
("error joininghread.");

38 
	`abÜt
();

40 
	`´štf
("\nmyglob®ƒqu® %d\n",
myglob®
);

41 
	`ex™
(0);

42 
	}
}

	@thread4.bk.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"cÚŒŞ.h
"

4 
	~"queue.h
"

5 
	~"dbug.h
"

9 
	swÜk_queue
 {

10 
d©a_cÚŒŞ
 
	mcÚŒŞ
;

11 
queue
 
	mwÜk
;

12 } 
	gwq
;

18 
	swÜk_node
 {

19 
node
 *
	mÃxt
;

20 
	mjobnum
;

21 } 
	twnode
;

28 
	sş—nup_queue
 {

29 
d©a_cÚŒŞ
 
	mcÚŒŞ
;

30 
queue
 
	mş—nup
;

31 } 
	gcq
;

40 
	sş—nup_node
 {

41 
node
 *
	mÃxt
;

42 
	mth»adnum
;

43 
±h»ad_t
 
	mtid
;

44 } 
	túode
;

46 *
	$th»adfunc
(*
my¬g
) {

48 
wnode
 *
mywÜk
;

49 
úode
 *
mynode
;

51 
mynode
=(
úode
 *è
my¬g
;

53 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

55 
wq
.
cÚŒŞ
.
aùive
) {

56 
wq
.
wÜk
.
h—d
==
NULL
 && wq.
cÚŒŞ
.
aùive
) {

57 
	`±h»ad_cÚd_wa™
(&
wq
.
cÚŒŞ
.
cÚd
, &wq.cÚŒŞ.
mu‹x
);

59 ià(!
wq
.
cÚŒŞ
.
aùive
)

62 
mywÜk
=(
wnode
 *è
	`queue_g‘
(&
wq
.
wÜk
);

63 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

65 
	`´štf
("Th»ad‚umb” %d…roûssšg job %d\n",
mynode
->
th»adnum
,
mywÜk
->
jobnum
);

66 
	`ä“
(
mywÜk
);

67 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

70 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

72 
	`±h»ad_mu‹x_lock
(&
cq
.
cÚŒŞ
.
mu‹x
);

73 
	`queue_put
(&
cq
.
ş—nup
,(
node
 *è
mynode
);

74 
	`±h»ad_mu‹x_uÆock
(&
cq
.
cÚŒŞ
.
mu‹x
);

75 
	`±h»ad_cÚd_sigÇl
(&
cq
.
cÚŒŞ
.
cÚd
);

76 
	`´štf
("th»ad %d shu‰šg down...\n",
mynode
->
th»adnum
);

77  
NULL
;

79 
	}
}

81 
	#NUM_WORKERS
 4

	)

83 
	gnumth»ads
;

85 
	$još_th»ads
() {

86 
úode
 *
cuºode
;

88 
	`´štf
("joininghreads...\n");

90 
numth»ads
) {

91 
	`±h»ad_mu‹x_lock
(&
cq
.
cÚŒŞ
.
mu‹x
);

98 
cq
.
ş—nup
.
h—d
==
NULL
) {

99 
	`±h»ad_cÚd_wa™
(&
cq
.
cÚŒŞ
.
cÚd
,&cq.cÚŒŞ.
mu‹x
);

110 
cuºode
 = (
úode
 *è
	`queue_g‘
(&
cq
.
ş—nup
);

111 
	`±h»ad_mu‹x_uÆock
(&
cq
.
cÚŒŞ
.
mu‹x
);

112 
	`±h»ad_još
(
cuºode
->
tid
,
NULL
);

113 
	`´štf
("jošed w™hh»ad %d\n",
cuºode
->
th»adnum
);

114 
	`ä“
(
cuºode
);

115 
numth»ads
--;

117 
	}
}

120 
	$ü—‹_th»ads
() {

121 
x
;

122 
úode
 *
cuºode
;

124 
x
=0; x<
NUM_WORKERS
; x++) {

125 
cuºode
=
	`m®loc
((
úode
));

126 ià(!
cuºode
)

128 
cuºode
->
th»adnum
=
x
;

129 ià(
	`±h»ad_ü—‹
(&
cuºode
->
tid
, 
NULL
, 
th»adfunc
, (*) curnode))

131 
	`´štf
("ü—‹dh»ad %d\n",
x
);

132 
numth»ads
++;

135 
	}
}

137 
	$š™Ÿlize_¡ruùs
() {

138 
numth»ads
=0;

139 ià(
	`cÚŒŞ_š™
(&
wq
.
cÚŒŞ
))

140 
	`dabÜt
();

141 
	`queue_š™
(&
wq
.
wÜk
);

142 ià(
	`cÚŒŞ_š™
(&
cq
.
cÚŒŞ
)) {

143 
	`cÚŒŞ_de¡roy
(&
wq
.
cÚŒŞ
);

144 
	`dabÜt
();

146 
	`queue_š™
(&
wq
.
wÜk
);

147 
	`cÚŒŞ_aùiv©e
(&
wq
.
cÚŒŞ
);

148 
	}
}

150 
	$ş—nup_¡ruùs
() {

151 
	`cÚŒŞ_de¡roy
(&
cq
.
cÚŒŞ
);

152 
	`cÚŒŞ_de¡roy
(&
wq
.
cÚŒŞ
);

153 
	}
}

156 
	$maš
() {

158 
x
;

159 
wnode
 *
mywÜk
;

161 
	`š™Ÿlize_¡ruùs
();

165 ià(
	`ü—‹_th»ads
()) {

166 
	`´štf
("Error startinghreads... cleaning up.\n");

167 
	`još_th»ads
();

168 
	`dabÜt
();

171 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

172 
x
=0; x<16000; x++) {

173 
mywÜk
=
	`m®loc
((
wnode
));

174 ià(!
mywÜk
) {

175 
	`´štf
("ouch! can't malloc!\n");

178 
mywÜk
->
jobnum
=
x
;

179 
	`queue_put
(&
wq
.
wÜk
,(
node
 *è
mywÜk
);

181 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

182 
	`±h»ad_cÚd_brßdÿ¡
(&
wq
.
cÚŒŞ
.
cÚd
);

184 
	`´štf
("sleeping...\n");

185 
	`¦“p
(2);

186 
	`´štf
("deactivating work queue...\n");

187 
	`cÚŒŞ_d—ùiv©e
(&
wq
.
cÚŒŞ
);

190 
	`još_th»ads
();

191 
	`ş—nup_¡ruùs
();

194 
	}
}

	@thread4.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"cÚŒŞ.h
"

4 
	~"queue.h
"

5 
	~"dbug.h
"

7 
	swÜk_queue
 {

8 
d©a_cÚŒŞ
 
	mcÚŒŞ
;

9 
queue
 
	mwÜk
;

10 } 
	gwq
;

13 
	swÜk_node
 {

14 
node
 *
	mÃxt
;

15 
	mjobnum
;

16 } 
	twnode
;

21 
	sş—nup_queue
 {

22 
d©a_cÚŒŞ
 
	mcÚŒŞ
;

23 
queue
 
	mş—nup
;

24 } 
	gcq
;

31 
	sş—nup_node
 {

32 
node
 *
	mÃxt
;

33 
	mth»adnum
;

34 
±h»ad_t
 
	mtid
;

35 } 
	túode
;

36 *
	$th»adfunc
(*
my¬g
) {

37 
wnode
 *
mywÜk
;

38 
úode
 *
mynode
;

39 
mynode
=(
úode
 *è
my¬g
;

40 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

41 
wq
.
cÚŒŞ
.
aùive
) {

42 
wq
.
wÜk
.
h—d
==
NULL
 && wq.
cÚŒŞ
.
aùive
) {

43 
	`±h»ad_cÚd_wa™
(&
wq
.
cÚŒŞ
.
cÚd
, &wq.cÚŒŞ.
mu‹x
);

45 ià(!
wq
.
cÚŒŞ
.
aùive
)

48 
mywÜk
=(
wnode
 *è
	`queue_g‘
(&
wq
.
wÜk
);

49 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

51 
	`´štf
("Th»ad‚umb” %d…roûssšg job %d\n",
mynode
->
th»adnum
,
mywÜk
->
jobnum
);

52 
	`ä“
(
mywÜk
);

53 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

55 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

56 
	`±h»ad_mu‹x_lock
(&
cq
.
cÚŒŞ
.
mu‹x
);

57 
	`queue_put
(&
cq
.
ş—nup
,(
node
 *è
mynode
);

58 
	`±h»ad_mu‹x_uÆock
(&
cq
.
cÚŒŞ
.
mu‹x
);

59 
	`±h»ad_cÚd_sigÇl
(&
cq
.
cÚŒŞ
.
cÚd
);

60 
	`´štf
("th»ad %d shu‰šg down...\n",
mynode
->
th»adnum
);

61  
NULL
;

63 
	}
}

64 
	#NUM_WORKERS
 4

	)

65 
	gnumth»ads
;

66 
	$još_th»ads
() {

67 
úode
 *
cuºode
;

68 
	`´štf
("joininghreads...\n");

69 
numth»ads
) {

70 
	`±h»ad_mu‹x_lock
(&
cq
.
cÚŒŞ
.
mu‹x
);

75 
cq
.
ş—nup
.
h—d
==
NULL
) {

76 
	`±h»ad_cÚd_wa™
(&
cq
.
cÚŒŞ
.
cÚd
,&cq.cÚŒŞ.
mu‹x
);

85 
cuºode
 = (
úode
 *è
	`queue_g‘
(&
cq
.
ş—nup
);

86 
	`±h»ad_mu‹x_uÆock
(&
cq
.
cÚŒŞ
.
mu‹x
);

87 
	`±h»ad_još
(
cuºode
->
tid
,
NULL
);

88 
	`´štf
("jošed w™hh»ad %d\n",
cuºode
->
th»adnum
);

89 
	`ä“
(
cuºode
);

90 
numth»ads
--;

92 
	}
}

93 
	$ü—‹_th»ads
() {

94 
x
;

95 
úode
 *
cuºode
;

96 
x
=0; x<
NUM_WORKERS
; x++) {

97 
cuºode
=
	`m®loc
((
úode
));

98 ià(!
cuºode
)

100 
cuºode
->
th»adnum
=
x
;

101 ià(
	`±h»ad_ü—‹
(&
cuºode
->
tid
, 
NULL
, 
th»adfunc
, (*) curnode))

103 
	`´štf
("ü—‹dh»ad %d\n",
x
);

104 
numth»ads
++;

107 
	}
}

108 
	$š™Ÿlize_¡ruùs
() {

109 
numth»ads
=0;

110 ià(
	`cÚŒŞ_š™
(&
wq
.
cÚŒŞ
))

111 
	`dabÜt
();

112 
	`queue_š™
(&
wq
.
wÜk
);

113 ià(
	`cÚŒŞ_š™
(&
cq
.
cÚŒŞ
)) {

114 
	`cÚŒŞ_de¡roy
(&
wq
.
cÚŒŞ
);

115 
	`dabÜt
();

117 
	`queue_š™
(&
wq
.
wÜk
);

118 
	`cÚŒŞ_aùiv©e
(&
wq
.
cÚŒŞ
);

119 
	}
}

120 
	$ş—nup_¡ruùs
() {

121 
	`cÚŒŞ_de¡roy
(&
cq
.
cÚŒŞ
);

122 
	`´štf
("done control_destroy cq\n");

123 
	`cÚŒŞ_de¡roy
(&
wq
.
cÚŒŞ
);

124 
	`´štf
("done control_destroy wq\n");

125 
	}
}

126 
	$maš
() {

127 
x
;

128 
wnode
 *
mywÜk
;

129 
	`š™Ÿlize_¡ruùs
();

132 ià(
	`ü—‹_th»ads
()) {

133 
	`´štf
("Error startinghreads... cleaning up.\n");

134 
	`još_th»ads
();

135 
	`dabÜt
();

137 
	`±h»ad_mu‹x_lock
(&
wq
.
cÚŒŞ
.
mu‹x
);

138 
x
=0; x<1600; x++) {

139 
mywÜk
=
	`m®loc
((
wnode
));

140 ià(!
mywÜk
) {

141 
	`´štf
("ouch! can't malloc!\n");

144 
mywÜk
->
jobnum
=
x
;

145 
	`queue_put
(&
wq
.
wÜk
,(
node
 *è
mywÜk
);

147 
	`±h»ad_mu‹x_uÆock
(&
wq
.
cÚŒŞ
.
mu‹x
);

148 
	`±h»ad_cÚd_brßdÿ¡
(&
wq
.
cÚŒŞ
.
cÚd
);

149 
	`´štf
("sleeping...\n");

150 
	`¦“p
(2);

151 
	`´štf
("deactivating work queue...\n");

152 
	`cÚŒŞ_d—ùiv©e
(&
wq
.
cÚŒŞ
);

154 
	`´štf
("done control_deactivate\n");

155 
	`još_th»ads
();

156 
	`´štf
("done join_threads\n");

157 
	`ş—nup_¡ruùs
();

158 
	`´štf
("done cleanup_structs\n");

159 
	}
}

	@
1
.
0
11
104
control.c
control.h
csapp.h
dbug.h
queue.c
queue.h
thread1.c
thread2.c
thread3.c
thread4.bk.c
thread4.c
